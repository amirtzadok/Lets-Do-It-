<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #25d366;
            --heart: #f43f5e;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --star-gold: #fbbf24;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); padding: 10px; display: flex; 
            flex-direction: column; align-items: center; 
            margin: 0; min-height: 100vh; box-sizing: border-box;
            padding-bottom: 80px;
        }

        .app-header { display: flex; align-items: center; justify-content: center; width: 100%; max-width: 480px; padding: 15px 0; position: relative; }
        .app-header h1 { font-size: 24px; font-weight: 900; color: var(--primary); margin: 0; }
        .header-btn { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; position: absolute; right: 0; }
        body[dir="rtl"] .header-btn { right: auto; left: 0; }

        .card { background: white; padding: 20px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: 480px; margin-bottom: 20px; box-sizing: border-box; }
        
        /* Avatar & Face Grid */
        .avatar-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .avatar-choice { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .avatar-btn { width: 50px; height: 50px; border-radius: 50%; border: 4px solid transparent; opacity: 0.5; object-fit: cover; }
        .avatar-choice.active .avatar-btn { border-color: var(--primary); opacity: 1; transform: scale(1.1); }

        .face-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; margin: 15px 0; }
        .face-wrapper { cursor: pointer; text-align: center; opacity: 0.4; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .face-wrapper.selected { opacity: 1; }
        .face-img { width: 42px; height: 42px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .face-wrapper.selected .face-img { border-color: var(--primary); }

        /* Star Rating */
        .stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; direction: ltr; }
        .star { font-size: 40px; cursor: pointer; color: #d1d5db; transition: 0.2s; }
        .star.active { color: var(--star-gold); }
        .rating-label { font-weight: bold; font-size: 18px; color: var(--primary); height: 24px; }

        /* General UI */
        input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 8px; }
        .primary-btn { width: 100%; padding: 16px; background: var(--whatsapp); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; font-size: 17px; }
        .primary-btn:disabled { background: #cbd5e1; }
        .secondary-btn { width: 100%; padding: 10px; background: #f1f5f9; color: #475569; border: none; border-radius: 15px; margin-top: 8px; font-weight: bold; }

        .list-item { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid var(--whatsapp); position: relative; }
        body[dir="rtl"] .list-item { border-left: none; border-right: 5px solid var(--whatsapp); }
        
        .action-icon { background: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; font-size: 14px; }
        .hidden { display: none !important; }
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .rating-card { background: white; border-radius: 30px; padding: 25px; width: 100%; max-width: 400px; text-align: center; }
    </style>
</head>
<body onload="init()">

    <header class="app-header">
        <h1>üöÄ Let's Do It!</h1>
        <button id="lang-toggle" class="header-btn" onclick="toggleLanguage()"></button>
    </header>

    <div id="setup-card" class="card hidden">
        <h2 data-i18n="whoAreYou">Who are you?</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled data-i18n="enterApp" style="margin-top:20px;">Let's do it!</button>
    </div>

    <div id="rating-modal" class="modal-bg hidden">
        <div class="rating-card">
            <h3 id="rate-title-main"></h3>
            <h1 id="rate-activity-name" style="margin: 10px 0; color: var(--primary);"></h1>
            <p id="rate-details" style="font-size: 14px; color: #64748b; margin-bottom: 15px;"></p>
            <div class="rating-label" id="rating-text"></div>
            <div class="stars" id="star-container">
                <span class="star" onclick="setRating(1)">‚òÖ</span>
                <span class="star" onclick="setRating(2)">‚òÖ</span>
                <span class="star" onclick="setRating(3)">‚òÖ</span>
                <span class="star" onclick="setRating(4)">‚òÖ</span>
                <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <button class="primary-btn" id="confirm-rate-btn" onclick="submitRating()" disabled data-i18n="submit">Send Rating</button>
            <button class="secondary-btn" onclick="closeRating()" data-i18n="close">Not now</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div id="user-info" style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold;" onclick="openHistory()"></div>
                <span style="font-size:11px; cursor:pointer; color:#94a3b8; font-weight:bold;" onclick="resetIdentity()" data-i18n="notMe">Not you?</span>
            </div>
            
            <h2 data-i18n="doSomething">Let's do something together!</h2>
            <input type="text" id="main-input" data-i18n-placeholder="planPlaceholder" oninput="updateUIState()">

            <div class="face-grid">
                <div id="faces-render" style="display:contents;"></div>
                <div class="face-wrapper" id="f-all" onclick="selectAll()"><div style="width:42px;height:42px;background:#fff1f2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;">‚ù§Ô∏è</div><p style="font-size:10px; font-weight:bold;" data-i18n="everyone">Everyone</p></div>
            </div>

            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled data-i18n="selectParticipants">Select Participants</button>
        </div>

        <div class="card">
            <h2 data-i18n="futureActivities">üöÄ Let's Do It!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        const i18n = {
            eng: {
                langBtn: "HEB", whoAreYou: "Who are you?", enterApp: "Let's do it!", welcomeUser: "Welcome {name}",
                hiUser: "Hi", doSomething: "Let's do something together!", planPlaceholder: "What's the plan?",
                everyone: "Everyone", everyoneInvite: "Everyone", futureActivities: "üöÄ Let's Do It!", 
                notMe: "Not you?", groupName: "Tzadok family", selectParticipants: "Select Participants",
                invitePrefix: "Invite", deleteConfirm: "Delete this?", close: "Close",
                rateIdea: "Rate {name}'s idea", submit: "Send Rating", needDetails: "Tap to add details!",
                ratings: ["", "Don't want to", "Probably no", "Maybe", "I like it", "Let's do it!"]
            },
            heb: {
                langBtn: "ENG", whoAreYou: "◊û◊ô ◊ê◊™/◊î?", enterApp: "◊ß◊ì◊ô◊û◊î!", welcomeUser: "◊ë◊®◊ï◊ö ◊î◊ë◊ê {name}",
                hiUser: "◊î◊ô◊ô", doSomething: "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊û◊©◊î◊ï ◊ë◊ô◊ó◊ì!", planPlaceholder: "◊û◊î ◊î◊™◊õ◊†◊ï◊ü?",
                everyone: "◊õ◊ï◊ú◊ù", everyoneInvite: "◊õ◊ï◊ú◊ù", futureActivities: "üöÄ ◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊ê◊™ ◊ñ◊î!", 
                notMe: "◊ñ◊î ◊ú◊ê ◊ê◊™/◊î?", groupName: "◊û◊©◊§◊ó◊™ ◊¶◊ì◊ï◊ß", selectParticipants: "◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù",
                invitePrefix: "◊î◊ñ◊û◊ü ◊ê◊™", deleteConfirm: "◊ú◊û◊ó◊ï◊ß?", close: "◊°◊í◊ï◊®",
                rateIdea: "◊ì◊®◊í◊ï ◊ê◊™ ◊î◊®◊¢◊ô◊ï◊ü ◊©◊ú {name}", submit: "◊©◊ú◊ó ◊ì◊ô◊®◊ï◊í", needDetails: "◊ú◊ó◊• ◊ú◊î◊ï◊°◊§◊™ ◊§◊®◊ò◊ô◊ù!",
                ratings: ["", "◊ú◊ê ◊®◊ï◊¶◊î", "◊õ◊†◊®◊ê◊î ◊©◊ú◊ê", "◊ê◊ï◊ú◊ô", "◊ê◊ï◊î◊ë ◊ê◊™ ◊ñ◊î", "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊ê◊™ ◊ñ◊î!"]
            }
        };

        const family = [
            { id: 1, name: "Amir", phone: "972547880404", img: "amir.png" },
            { id: 2, name: "Rani", phone: "972542428664", img: "rani.png" },
            { id: 3, name: "Lia", phone: "972526765297", img: "lia.png" },
            { id: 4, name: "Gal", phone: "972553054450", img: "gal.png" }
        ];

        let currentLang = localStorage.getItem('ldit_lang') || 'eng';
        let currentUser = JSON.parse(localStorage.getItem('ldit_user'));
        let activities = JSON.parse(localStorage.getItem('ldit_list')) || [];
        let selected = [];
        let tempRating = 0;
        let incomingIdea = null;

        function toggleLanguage() {
            currentLang = currentLang === 'eng' ? 'heb' : 'eng';
            localStorage.setItem('ldit_lang', currentLang);
            location.reload();
        }

        function init() {
            const d = i18n[currentLang];
            document.body.dir = currentLang === 'heb' ? 'rtl' : 'ltr';
            document.getElementById('lang-toggle').innerText = d.langBtn;
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = d[el.getAttribute('data-i18n')]);

            const params = new URLSearchParams(window.location.search);
            if (params.get('import')) {
                incomingIdea = {
                    id: params.get('id') || Date.now(), title: params.get('t'), details: params.get('d'),
                    creator: params.get('c'), p: params.get('p')
                };
                showRatingModal();
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (!currentUser) {
                document.getElementById('setup-card').classList.remove('hidden');
                renderSetup();
            } else showMainApp();
        }

        function showRatingModal() {
            document.getElementById('rate-title-main').innerText = i18n[currentLang].rateIdea.replace("{name}", incomingIdea.creator);
            document.getElementById('rate-activity-name').innerText = incomingIdea.title;
            document.getElementById('rate-details').innerText = incomingIdea.details || "";
            document.getElementById('rating-modal').classList.remove('hidden');
        }

        function setRating(num) {
            tempRating = num;
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => s.classList.toggle('active', i < num));
            document.getElementById('rating-text').innerText = i18n[currentLang].ratings[num];
            document.getElementById('confirm-rate-btn').disabled = false;
        }

        function submitRating() {
            if (tempRating >= 4) {
                if (!activities.find(a => a.id == incomingIdea.id)) {
                    activities.push({...incomingIdea, dateRaw: '', time: ''});
                    localStorage.setItem('ldit_list', JSON.stringify(activities));
                }
            }
            closeRating();
            if (currentUser) renderFinalList();
        }

        function closeRating() { document.getElementById('rating-modal').classList.add('hidden'); }

        function renderSetup() {
            document.getElementById('avatar-selector').innerHTML = family.map(f => `
                <div class="avatar-choice" id="choice-${f.id}" onclick="selectSelf(${f.id}, '${f.name}')">
                    <img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/80'">
                    <span style="font-size:11px;font-weight:bold;">${f.name}</span>
                </div>`).join('');
        }

        function selectSelf(id, name) {
            document.querySelectorAll('.avatar-choice').forEach(el => el.classList.remove('active'));
            document.getElementById(`choice-${id}`).classList.add('active');
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.innerText = i18n[currentLang].welcomeUser.replace("{name}", name);
            window.tempId = id;
        }

        function finishSetup() {
            currentUser = family.find(f => f.id === window.tempId);
            localStorage.setItem('ldit_user', JSON.stringify(currentUser));
            location.reload();
        }

        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-info').innerHTML = `<img src="${currentUser.img}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;"> ${i18n[currentLang].hiUser}, ${currentUser.name}`;
            document.getElementById('faces-render').innerHTML = family.map(f => `
                <div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})">
                    <img src="${f.img}" class="face-img" onerror="this.src='https://via.placeholder.com/50'">
                    <p style="font-size:10px; font-weight:bold;">${f.name}</p>
                </div>`).join('');
            renderFinalList();
        }

        function toggleFace(id) {
            const idx = selected.indexOf(id);
            idx > -1 ? selected.splice(idx, 1) : selected.push(id);
            updateUIState();
        }

        function selectAll() {
            selected = (selected.length === family.length) ? [] : family.map(f => f.id);
            updateUIState();
        }

        function updateUIState() {
            const val = document.getElementById('main-input').value;
            family.forEach(f => document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)));
            const btn = document.getElementById('action-btn');
            btn.disabled = !(selected.length > 0 && val);
            if (selected.length > 0) {
                const target = selected.length === family.length ? i18n[currentLang].everyoneInvite : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
                btn.innerText = `${i18n[currentLang].invitePrefix} ${target}`;
            }
        }

        function sendWA() {
            const title = document.getElementById('main-input').value;
            const isEveryone = selected.length === family.length;
            const pNames = isEveryone ? i18n[currentLang].groupName : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
            const id = Date.now();

            const params = new URLSearchParams({ import: 'true', id, t: title, c: currentUser.name, p: pNames });
            const magicLink = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            const waText = `üöÄ *${currentUser.name}* has a new idea: *${title}*\n\nRate it here to confirm:\n${magicLink}`;

            const phone = (!isEveryone && selected.length === 1) ? family.find(f => f.id === selected[0]).phone : "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(waText)}`, '_blank');
            location.reload();
        }

        function renderFinalList() {
            document.getElementById('final-list').innerHTML = activities.map(a => {
                const isCreator = currentUser && a.creator === currentUser.name;
                const needsDetails = isCreator && (!a.dateRaw || !a.time);
                return `
                <div class="list-item" style="${needsDetails ? 'border-left-color: var(--heart);' : ''}">
                    <div style="position:absolute; right:12px; top:12px;" class="action-icon" onclick="deleteItem(${a.id})">üóëÔ∏è</div>
                    <b>${a.title}</b><br>
                    <small>${a.creator} | ${a.joinedBy}</small>
                    ${a.dateRaw ? `<br><span style="font-size:12px; font-weight:bold;">üìÖ ${a.dateRaw} @ ${a.time}</span>` : ''}
                    ${needsDetails ? `<div style="color:var(--heart); font-size:11px; font-weight:bold; cursor:pointer;" onclick="editActivity(${a.id})">‚ö†Ô∏è ${i18n[currentLang].needDetails}</div>` : ''}
                </div>`;
            }).join('') || `<p>No confirmed activities yet.</p>`;
        }

        function editActivity(id) {
            const a = activities.find(x => x.id == id);
            const date = prompt("Date (YYYY-MM-DD):", a.dateRaw);
            const time = prompt("Time (HH:MM):", a.time);
            if (date && time) {
                a.dateRaw = date; a.time = time;
                localStorage.setItem('ldit_list', JSON.stringify(activities));
                renderFinalList();
            }
        }

        function deleteItem(id) { if(confirm(i18n[currentLang].deleteConfirm)) { activities = activities.filter(a => a.id != id); localStorage.setItem('ldit_list', JSON.stringify(activities)); renderFinalList(); } }
        function resetIdentity() { localStorage.removeItem('ldit_user'); location.reload(); }
    </script>
</body>
</html>
