<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #58d368;
            --heart: #f43f5e;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: 480px; margin-bottom: 20px; box-sizing: border-box; }
        
        /* Desktop specific adjustments */
        @media (min-width: 768px) {
            body { padding: 40px; }
            .card { max-width: 800px; padding: 40px; }
            .avatar-options { grid-template-columns: repeat(4, 1fr) !important; } 
            .faces-container { gap: 25px !important; }
            .logo-container img { width: 220px !important; }
            #setup-card .primary-btn { width: 33.33%; }
        }

        h2 { font-size: 22px; font-weight: 800; margin-top: 0; margin-bottom: 15px; text-align: center; }

        /* Shared Logo UI */
        .logo-container { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; padding-top: 20px; }
        .logo-container img { width: 160px; height: auto; }

        /* Setup Screen */
        .avatar-options { display: grid; grid-template-columns: 1fr; gap: 15px; justify-items: center; margin: 20px 0; }
        .avatar-choice { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; }
        .avatar-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid transparent; opacity: 0.5; transition: 0.3s; object-fit: cover; }
        .avatar-choice.active .avatar-btn { border-color: var(--primary); opacity: 1; transform: scale(1.05); }
        .avatar-choice span { font-weight: bold; margin-top: 5px; font-size: 14px; opacity: 0.6; }
        .avatar-choice.active span { opacity: 1; color: var(--primary); }

        /* Main App UI */
        .user-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        .input-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
        input[type="text"], input[type="date"], input[type="time"], textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; outline: none; margin-bottom: 10px; }
        .clear-x { position: absolute; right: 12px; top: 22px; transform: translateY(-50%); background: #cbd5e1; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: none; align-items: center; justify-content: center; font-weight: bold; z-index: 5; }

        .faces-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .face-wrapper { cursor: pointer; text-align: center; transition: 0.3s; opacity: 0.4; }
        .face-wrapper.selected { opacity: 1; transform: translateY(-5px); }
        .face { width: 55px; height: 55px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .face-wrapper.selected .face { border-color: var(--primary); }
        .heart-box { width: 55px; height: 55px; background: #fff1f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; border: 3px solid transparent; }
        .face-wrapper.selected .heart-box { border-color: var(--heart); }

        /* Buttons & List */
        .primary-btn { width: 100%; padding: 18px; background: var(--whatsapp); color: white; border: none; border-radius: 20px; font-weight: 800; cursor: pointer; font-size: 18px; display: block; margin: 0 auto; }
        #setup-card .primary-btn { width: 66%; }
        .primary-btn:disabled { background: #ccc; cursor: not-allowed; }
        .secondary-btn { width: 100%; padding: 12px; background: #cbd5e1; color: white; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .list-item { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid var(--whatsapp); position: relative; }
        .item-actions { position: absolute; right: 15px; top: 15px; display: flex; gap: 12px; cursor: pointer; font-size: 18px; }

        /* Rating UI */
        .stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; font-size: 35px; color: #ddd; cursor: pointer; }
        .stars span.active { color: #facc15; }
        .star-label { text-align: center; font-weight: bold; color: var(--primary); margin-bottom: 20px; min-height: 20px; }

        .hidden { display: none !important; }
        .reset-link { font-size: 11px; color: #94a3b8; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body onload="init()">

    <div id="rating-screen" class="card hidden">
        <div class="logo-container">
            <img src="logo.png" alt="Let's Do It Logo" onerror="this.src='https://raw.githubusercontent.com/amirtzadok/Lets-Do-It-/main/logo.png'">
        </div>
        <h2 style="text-align:center">Rate the Idea!</h2>
        <p id="rate-idea-name" style="text-align:center; font-size:18px; font-weight:bold; color:#334155;"></p>
        <div class="stars" id="star-row">
            <span onclick="setStars(1)">‚òÖ</span><span onclick="setStars(2)">‚òÖ</span><span onclick="setStars(3)">‚òÖ</span><span onclick="setStars(4)">‚òÖ</span><span onclick="setStars(5)">‚òÖ</span>
        </div>
        <div id="star-desc" class="star-label">Choose your rating</div>
        <button class="primary-btn" onclick="submitRating()">Submit Vote</button>
    </div>

    <div id="edit-modal" class="card hidden" style="position: fixed; top: 5%; z-index: 100; max-height: 90vh; overflow-y: auto; border: 2px solid var(--primary); width: 90%; max-width: 450px;">
        <h3>Edit Logistics</h3>
        <textarea id="edit-desc" placeholder="Where / What we do?"></textarea>
        <input type="date" id="edit-date">
        <input type="time" id="edit-time"> <button class="primary-btn" id="edit-notify-btn" onclick="saveAndNotify()">Save & Notify Joined Participants</button>
        <button class="secondary-btn" onclick="closeEdit()">Cancel</button>
    </div>

    <div id="setup-card" class="card hidden">
        <div class="logo-container">
            <img src="logo.png" alt="Let's Do It Logo" onerror="this.src='https://raw.githubusercontent.com/amirtzadok/Lets-Do-It-/main/logo.png'">
        </div>
        <h2>Choose your avatar</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled>Let's do it!</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div class="user-header">
                <div id="user-info" class="user-info"></div>
                <span class="reset-link" onclick="resetIdentity()">Not me?</span>
            </div>
            <h2>Let's do something together!</h2>
            
            <div class="input-wrapper">
                <input type="text" id="main-input" placeholder="What's the plan?" oninput="updateUIState(); toggleX('main-input', 'main-clear')">
                <button id="main-clear" class="clear-x" onclick="clearField('main-input', 'main-clear'); updateUIState()">‚úï</button>
            </div>

            <div class="faces-container">
                <div class="face-wrapper" id="f-all" onclick="selectAll()">
                    <div class="heart-box">‚ù§Ô∏è</div>
                    <p style="font-size:10px; margin-top:5px; font-weight:bold; color:var(--heart);">Everyone</p>
                </div>
                <div id="faces-render" style="display:flex; gap:10px;"></div>
            </div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled>Select Participants</button>
        </div>

        <div class="card">
            <h2>üöÄ Let's Do It!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        const family = [
            { id: 1, name: "Amir", phone: "972547880404", img: "amir.png" },
            { id: 2, name: "Rani", phone: "972542428664", img: "rani.png" },
            { id: 3, name: "Lia", phone: "972526765297", img: "lia.png" },
            { id: 4, name: "Gal", phone: "972553054450", img: "gal.png" }
        ];

        let creatorIdentity = JSON.parse(localStorage.getItem('letsdoit_user_identity'));
        let selected = [];
        let currentRating = 0;
        let editingId = null;
        let activities = JSON.parse(localStorage.getItem('letsdoit_final_list')) || [];

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const rateName = urlParams.get('rate');
            const creator = urlParams.get('creator');

            if (rateName) {
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('setup-card').classList.add('hidden');
                document.getElementById('rating-screen').classList.remove('hidden');
                document.getElementById('rate-idea-name').innerText = `"${rateName}"`;
                return;
            }

            if (!creatorIdentity) {
                document.getElementById('setup-card').classList.remove('hidden');
                document.getElementById('avatar-selector').innerHTML = family.map(f => `
                    <div class="avatar-choice" id="choice-${f.id}" onclick="selectSelf(${f.id})">
                        <img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/80'">
                        <span>${f.name}</span>
                    </div>
                `).join('');
            } else {
                showMainApp();
            }
        }

        // --- RATING LOGIC ---
        const starLabels = { 1: "No thanks", 2: "Probably not", 3: "Maybe", 4: "I like it!", 5: "LET'S DO IT!" };
        function setStars(n) {
            currentRating = n;
            const stars = document.querySelectorAll('#star-row span');
            stars.forEach((s, i) => s.classList.toggle('active', i < n));
            document.getElementById('star-desc').innerText = starLabels[n];
        }

        function submitRating() {
            if (currentRating === 0) return alert("Pick stars!");
            const params = new URLSearchParams(window.location.search);
            const idea = params.get('rate');
            const creatorName = params.get('creator');

            if (currentRating >= 4) {
                activities.push({ 
                    id: Date.now(), 
                    title: idea, 
                    dateAdded: new Date().toLocaleDateString(),
                    creator: creatorName,
                    participants: params.get('participants') || 'Tzadok Family'
                });
                localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
                
                // Notify creator logic
                const creatorObj = family.find(f => f.name === creatorName);
                if (creatorObj) {
                    const msg = `Hey ${creatorName}! Your activity "${idea}" was joined! üöÄ Time to edit your activity details.`;
                    window.open(`https://wa.me/${creatorObj.phone}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }
            window.location.href = window.location.pathname;
        }

        // --- LOGISTICS & AUTOMATED CALENDAR ---
        function openEdit(id) {
            editingId = id;
            const item = activities.find(a => a.id === id);
            document.getElementById('edit-desc').value = item.details || '';
            document.getElementById('edit-date').value = item.dateRaw || '';
            document.getElementById('edit-time').value = item.time || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function saveAndNotify() {
            const idx = activities.findIndex(a => a.id === editingId);
            const item = activities[idx];
            item.details = document.getElementById('edit-desc').value;
            item.dateRaw = document.getElementById('edit-date').value;
            item.time = document.getElementById('edit-time').value;
            localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));

            // Default Calendar Logic
            const dateStr = (item.dateRaw || "").replace(/-/g, '');
            const timeStr = (item.time || "1000").replace(/:/g, '');
            const calUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(item.title)}&dates=${dateStr}T${timeStr}00/${dateStr}T${parseInt(timeStr)+1}00&details=${encodeURIComponent(item.details || '')}&location=Israel&sf=true&output=xml`;
            
            const msg = `UPDATE: *${item.title}*\nüìÖ When: ${item.dateRaw} @ ${item.time}\nüìç Where: ${item.details}\n\nAdd to calendar: ${calUrl}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            closeEdit();
            renderFinalList();
        }

        // --- UI UTILS ---
        function selectSelf(id) {
            tempSelectedId = id;
            document.querySelectorAll('.avatar-choice').forEach(el => el.classList.remove('active'));
            document.getElementById(`choice-${id}`).classList.add('active');
            document.getElementById('start-btn').disabled = false;
        }

        function finishSetup() {
            creatorIdentity = family.find(f => f.id === tempSelectedId);
            localStorage.setItem('letsdoit_user_identity', JSON.stringify(creatorIdentity));
            document.getElementById('setup-card').classList.add('hidden');
            showMainApp();
        }

        function resetIdentity() {
            if(confirm("Change user profile?")) {
                localStorage.removeItem('letsdoit_user_identity');
                location.reload();
            }
        }

        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-info').innerHTML = `
                <img src="${creatorIdentity.img}" onerror="this.src='https://via.placeholder.com/40'">
                <span style="font-weight:bold; font-size:14px;">Hi, ${creatorIdentity.name}</span>
            `;
            document.getElementById('faces-render').innerHTML = family.map(f => `
                <div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})">
                    <img src="${f.img}" class="face" onerror="this.src='https://via.placeholder.com/55'">
                    <p style="font-size:10px; margin-top:5px; font-weight:bold;">${f.name}</p>
                </div>
            `).join('');
            renderFinalList();
        }

        function toggleX(inp, btn) { document.getElementById(btn).style.display = document.getElementById(inp).value ? 'flex' : 'none'; }
        function clearField(inp, btn) { document.getElementById(inp).value = ''; toggleX(inp, btn); }
        function toggleFace(id) { const i = selected.indexOf(id); i > -1 ? selected.splice(i, 1) : selected.push(id); updateUIState(); }
        function selectAll() { selected = selected.length === family.length ? [] : family.map(f => f.id); updateUIState(); }
        function closeEdit() { document.getElementById('edit-modal').classList.add('hidden'); }

        function updateUIState() {
            const val = document.getElementById('main-input').value;
            const btn = document.getElementById('action-btn');
            family.forEach(f => document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)));
            document.getElementById('f-all').classList.toggle('selected', selected.length === family.length);
            if (selected.length === 0) { btn.innerText = "Select Participants"; btn.disabled = true; }
            else { 
                const names = selected.length === family.length ? "Everyone" : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
                btn.innerText = `Invite ${names}`; btn.disabled = !val; 
            }
        }

        function sendWA() {
            const activity = document.getElementById('main-input').value;
            const chosen = family.filter(f => selected.includes(f.id));
            const participants = selected.length === family.length ? "Everyone" : chosen.map(f => f.name).join(' & ');
            const baseUrl = window.location.origin + window.location.pathname;
            const ratingUrl = `${baseUrl}?rate=${encodeURIComponent(activity)}&creator=${encodeURIComponent(creatorIdentity.name)}&participants=${encodeURIComponent(participants)}`;
            
            const msg = `üöÄ Let's Do It!\n${creatorIdentity.name} suggested "${activity}".\n\nRate it here:\n${ratingUrl}`;
            let waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            if (chosen.length === 1) waUrl = `https://wa.me/${chosen[0].phone}?text=${encodeURIComponent(msg)}`;
            window.open(waUrl, '_blank');
        }

        function renderFinalList() {
            document.getElementById('final-list').innerHTML = activities.map(a => `
                <div class="list-item">
                    <div class="item-actions"><span onclick="openEdit(${a.id})">üìù</span> <span onclick="deleteIdea(${a.id})">üóëÔ∏è</span></div>
                    <div style="font-weight:bold;">${a.title}</div>
                </div>
            `).join('') || '<p style="color:#94a3b8; font-size:12px; text-align:center;">No activities yet.</p>';
        }

        function deleteIdea(id) { activities = activities.filter(a => a.id !== id); localStorage.setItem('letsdoit_final_list', JSON.stringify(activities)); renderFinalList(); }
    </script>
</body>
</html>
