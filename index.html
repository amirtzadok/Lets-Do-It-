<body onload="init()">

    <div id="rating-screen" class="card hidden">
        <div class="welcome-logo-container">
            <img src="logo.png" alt="Let's Do It Logo" onerror="this.src='https://raw.githubusercontent.com/amirtzadok/Lets-Do-It-/main/logo.png'">
        </div>
        <h2 id="rating-header" style="text-align:center; font-size:17px;"></h2>
        <p id="rating-prompt" style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:15px;">Rate their idea!</p>
        
        <div class="stars" id="star-row">
            <span onclick="setStars(1)">‚òÖ</span><span onclick="setStars(2)">‚òÖ</span><span onclick="setStars(3)">‚òÖ</span><span onclick="setStars(4)">‚òÖ</span><span onclick="setStars(5)">‚òÖ</span>
        </div>
        <div id="star-desc" class="star-label">Choose your rating</div>
        
        <button class="primary-btn" id="submit-vote-btn" onclick="submitRating()" disabled style="margin-top: 15px;">Let's do it!</button>
    </div>

    <div id="setup-card" class="card hidden">
        <div class="welcome-logo-container">
            <img src="logo.png" alt="Let's Do It Logo" onerror="this.src='https://raw.githubusercontent.com/amirtzadok/Lets-Do-It-/main/logo.png'">
        </div>
        <h2 class="setup-title">Choose your avatar</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled>Let's do it!</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div class="user-header">
                <div id="user-info" class="user-info"></div>
                <span class="reset-link" onclick="resetIdentity()">Not me?</span>
            </div>
            <h2>Let's do something together!</h2>
            
            <div class="input-wrapper">
                <input type="text" id="main-input" placeholder="What's the plan?" oninput="updateUIState(); toggleX('main-input', 'main-clear')">
                <button id="main-clear" class="clear-x" onclick="clearField('main-input', 'main-clear'); updateUIState()">‚úï</button>
            </div>

            <div class="faces-container">
                <div class="face-wrapper" id="f-all" onclick="selectAll()">
                    <div class="heart-box">‚ù§Ô∏è</div>
                    <p style="font-size:10px; margin-top:5px; font-weight:bold; color:var(--heart);">Everyone</p>
                </div>
                <div id="faces-render" style="display:flex; gap:10px;"></div>
            </div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled>Select Participants</button>
        </div>

        <div class="card">
            <h2>üöÄ Let's Do It!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        // Ensure init() correctly hides/shows screens
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const rateName = urlParams.get('rate');
            const creator = urlParams.get('creator');
            const editId = urlParams.get('editId');

            // 1. Check for rating screen first
            if (rateName) {
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('setup-card').classList.add('hidden');
                document.getElementById('rating-screen').classList.remove('hidden');
                document.getElementById('rating-header').innerText = `${creator} created an activity for "${rateName}"`;
                return;
            }

            // 2. Check if user is logged in
            if (!creatorIdentity) {
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('setup-card').classList.remove('hidden');
                document.getElementById('avatar-selector').innerHTML = family.map(f => `
                    <div class="avatar-choice" id="choice-${f.id}" onclick="selectSelf(${f.id})">
                        <img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/90'">
                        <span>${f.name}</span>
                    </div>
                `).join('');
            } else {
                // 3. User is logged in, show main app
                document.getElementById('setup-card').classList.add('hidden');
                showMainApp();
                if (editId) openEdit(parseInt(editId));
            }
        }
        
        // ... rest of your script functions (selectSelf, finishSetup, etc.)
    </script>
</body>
