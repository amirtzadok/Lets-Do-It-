<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #58d368;
            --heart: #f43f5e;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); padding: 10px; display: flex; 
            flex-direction: column; align-items: center; justify-content: flex-start;
            margin: 0; min-height: 100vh; box-sizing: border-box; 
        }

        .app-header {
            display: flex; align-items: center; justify-content: center;
            width: 100%; max-width: 480px; padding: 15px 0; position: relative;
        }
        .app-header h1 { font-size: 24px; font-weight: 900; color: var(--primary); margin: 0; }

        .header-btn {
            background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px;
            border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; position: absolute;
            top: 50%; transform: translateY(-50%);
        }
        #help-btn { font-size: 16px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        .card { background: white; padding: 20px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: 480px; margin-bottom: 20px; box-sizing: border-box; }
        
        .avatar-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 5px; width: 100%; }
        .avatar-choice { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; }
        .avatar-btn { width: 40px; height: 40px; border-radius: 50%; border: 4px solid transparent; opacity: 0.5; object-fit: cover; }
        .avatar-choice.active .avatar-btn { border-color: var(--primary); opacity: 1; transform: scale(1.05); }
        .avatar-choice span { font-size: 11px; margin-top: 4px; font-weight: bold; }

        @media (max-width: 400px) { .avatar-options { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 768px) { .card, .app-header { max-width: 600px; } }

        .user-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-header img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 8px; }
        input[type="file"] { font-size: 12px; margin-bottom: 10px; }

        .primary-btn { width: 100%; padding: 16px; background: var(--whatsapp); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; font-size: 17px; }
        .secondary-btn { width: 100%; padding: 10px; background: #cbd5e1; color: white; border: none; border-radius: 15px; margin-top: 8px; }

        .list-item { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid var(--whatsapp); position: relative; cursor: pointer; }
        .item-delete { position: absolute; top: 12px; cursor: pointer; font-size: 16px; z-index: 5; opacity: 0.6; }
        body[dir="rtl"] .item-delete { right: auto; left: 12px; }

        /* Small creator avatar inside list items */
        .creator-badge { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-inline-end: 8px; border: 1px solid #ddd; }

        .face-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; margin: 15px 0; }
        .face-wrapper { cursor: pointer; text-align: center; opacity: 0.4; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .face-wrapper.selected { opacity: 1; }
        .face-img { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .face-wrapper.selected .face-img { border-color: var(--primary); }
        .heart-box { width: 40px; height: 40px; background: #fff1f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        .image-gallery { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; }
        .image-gallery img { height: 60px; border-radius: 8px; border: 1px solid #ddd; }
        .link-btn { display: inline-block; background: #e2e8f0; color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; text-decoration: none; margin-top: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body onload="init()">

    <header class="app-header">
        <button id="help-btn" class="header-btn" onclick="openGuide()">?</button>
        <h1 id="app-name-display">üöÄ Let's Do It!</h1>
        <button id="lang-toggle" class="header-btn" onclick="toggleLanguage()"></button>
    </header>

    <div id="guide-panel" class="card hidden" style="position: fixed; top: 5%; z-index: 200; border: 2px solid var(--primary); width: 95%; max-width: 450px;">
        <h2 data-i18n="guideTitle">How it works</h2>
        <div id="guide-content"></div>
        <button class="primary-btn" onclick="closeGuide()" data-i18n="close">Got it!</button>
    </div>

    <div id="edit-modal" class="card hidden" style="position: fixed; top: 5%; z-index: 1000; border: 2px solid var(--primary); width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto;">
        <h3 id="modal-title" data-i18n="editLogistics">Edit Details</h3>
        <div id="unified-edit-fields">
            <input type="text" id="modal-edit-title" placeholder="Activity Name">
            <textarea id="modal-edit-desc" data-i18n-placeholder="descPlaceholder" placeholder="Notes/Description"></textarea>
            <div style="display:flex; gap:5px;">
                <input type="date" id="modal-edit-date" style="flex:1;">
                <input type="time" id="modal-edit-time" style="flex:1;">
            </div>
            <select id="modal-edit-duration">
                <option value="" disabled selected data-i18n="chooseDuration">Duration</option>
                <option value="1-3" data-i18n="dur1">1-3 hours</option>
                <option value="half" data-i18n="dur2">half a day</option>
                <option value="full" data-i18n="dur3">full day</option>
            </select>
            <input type="text" id="modal-edit-url" placeholder="Paste link (URL)">
            <input type="file" id="modal-edit-images" multiple accept="image/*">
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button class="primary-btn" onclick="syncAndSaveGlobal()" style="flex:2;" data-i18n="update">Update</button>
                <button class="secondary-btn" onclick="closeEdit()" style="flex:1; margin-top:0;" data-i18n="cancel">Cancel</button>
            </div>
        </div>
        <div id="view-fields" class="hidden">
            <p id="view-desc" style="background:#f1f5f9; padding:12px; border-radius:12px;"></p>
            <p id="view-datetime" style="font-weight:bold; color:var(--primary);"></p>
            <p id="view-duration" style="font-style:italic; font-size:13px;"></p>
            <div id="view-link-container"></div>
            <div id="view-images-container" class="image-gallery"></div>
        </div>
        <button id="modal-close-btn" class="secondary-btn hidden" onclick="closeEdit()" data-i18n="close">Close</button>
    </div>

    <div id="rating-screen" class="card hidden">
        <h2 id="rating-header"></h2>
        <div class="stars" id="star-row" style="display:flex; justify-content:center; font-size:32px; color:#ddd; cursor:pointer; margin-bottom:10px;">
            <span onclick="setStars(1)">‚òÖ</span><span onclick="setStars(2)">‚òÖ</span><span onclick="setStars(3)">‚òÖ</span><span onclick="setStars(4)">‚òÖ</span><span onclick="setStars(5)">‚òÖ</span>
        </div>
        <button class="primary-btn" id="submit-vote-btn" onclick="submitRating()" disabled data-i18n="submitVote">Let's do it!</button>
    </div>

    <div id="suggestions-panel" class="card hidden" style="position: fixed; top: 5%; z-index: 99; border: 2px solid var(--whatsapp); width: 95%; max-width: 450px; max-height: 85vh; overflow-y: auto;">
        <h2 data-i18n="mySuggestionsTitle">My Suggestions</h2>
        <div id="suggestions-list-content"></div>
        <button class="secondary-btn" onclick="closeSuggestions()" data-i18n="close">Close</button>
    </div>

    <div id="setup-card" class="card hidden">
        <h2 data-i18n="whoAreYou">Who are you?</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled data-i18n="enterApp">Let's do it!</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div class="user-header">
                <div id="user-info" class="user-info" onclick="openSuggestions()"></div>
                <span style="font-size:11px; cursor:pointer; color:#94a3b8;" onclick="resetIdentity()" data-i18n="notMe">Not me?</span>
            </div>
            <h2 data-i18n="doSomething">let's do something together!</h2>
            <div class="input-row">
                <input type="text" id="main-input" data-i18n-placeholder="planPlaceholder" oninput="updateUIState()">
                <button style="background:none; border:none; color:#ccc; cursor:pointer;" onclick="clearInput()">‚úï</button>
            </div>
            <button class="toggle-logistics-btn" onclick="toggleSuggestLogistics()" data-i18n="addDetailsNow">+ Add details now (optional)</button>
            <div id="suggest-logistics-fields" class="hidden optional-logistics">
                <textarea id="suggest-desc" data-i18n-placeholder="descPlaceholder"></textarea>
                <div style="display:flex; gap:5px;"><input type="date" id="suggest-date" style="flex:1;"><input type="time" id="suggest-time" style="flex:1;"></div>
                <select id="suggest-duration">
                    <option value="" disabled selected data-i18n="chooseDuration">Duration</option>
                    <option value="1-3" data-i18n="dur1">1-3 hours</option>
                    <option value="half" data-i18n="dur2">half a day</option>
                    <option value="full" data-i18n="dur3">full day</option>
                </select>
                <input type="text" id="suggest-url" placeholder="Paste link (URL)">
                <input type="file" id="suggest-images" multiple accept="image/*">
                <button class="secondary-btn" onclick="toggleSuggestLogistics()" data-i18n="cancel">Cancel</button>
            </div>
            <div class="face-grid">
                <div id="faces-render" style="display:contents;"></div>
                <div class="face-wrapper" id="f-all" onclick="selectAll()"><div class="heart-box">‚ù§Ô∏è</div><p style="font-size:10px; font-weight:bold;" data-i18n="everyone">Everyone</p></div>
            </div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled data-i18n="selectParticipants"></button>
        </div>
        <div class="card">
            <h2 data-i18n="futureActivities">üöÄ Future Activities!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        const i18n = {
            eng: {
                langBtn: "HEB", close: "Close", update: "Update", cancel: "Cancel",
                editLogistics: "Edit Details", descPlaceholder: "Notes/Description", whoAreYou: "Who are you?", 
                hiUser: "Hi", doSomething: "Let's do something together!", planPlaceholder: "What's the plan?", 
                everyone: "Everyone", futureActivities: "üöÄ Future Activities!", addDetailsNow: "+ Add details now",
                dur1: "1-3 hours", dur2: "half a day", dur3: "full day", chooseDuration: "Duration",
                mySuggestionsTitle: "My Suggestions", deleteConfirm: "Delete this?", groupName: "Tzadok family",
                selectParticipants: "Select Participants", invitePrefix: "Invite", viewLink: "üîó View Link",
                waRatingMsg: "liked your idea", waConfirmed: "Confirmed!", waNegativeRating: "Try another one!"
            },
            heb: {
                langBtn: "ENG", close: "◊°◊í◊ï◊®", update: "◊¢◊ì◊õ◊ü", cancel: "◊ë◊ô◊ò◊ï◊ú",
                editLogistics: "◊¢◊®◊ï◊ö ◊§◊®◊ò◊ô◊ù", descPlaceholder: "◊™◊ô◊ê◊ï◊®/◊î◊¢◊®◊ï◊™", whoAreYou: "◊û◊ô ◊ê◊™/◊î?", 
                hiUser: "◊î◊ô◊ô", doSomething: "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊û◊©◊î◊ï ◊ë◊ô◊ó◊ì!", planPlaceholder: "◊û◊î ◊î◊™◊õ◊†◊ï◊ü?", 
                everyone: "◊õ◊ï◊ú◊ù", futureActivities: "üöÄ ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊¢◊™◊ô◊ì◊ô◊ï◊™!", addDetailsNow: "+ ◊î◊ï◊°◊ô◊§◊ï ◊§◊®◊ò◊ô◊ù ◊¢◊õ◊©◊ô◊ï",
                dur1: "1-3 ◊©◊¢◊ï◊™", dur2: "◊ó◊¶◊ô ◊ô◊ï◊ù", dur3: "◊ô◊ï◊ù ◊©◊ú◊ù", chooseDuration: "◊û◊©◊ö ◊ñ◊û◊ü",
                mySuggestionsTitle: "◊î◊î◊¶◊¢◊ï◊™ ◊©◊ú◊ô", deleteConfirm: "◊ú◊û◊ó◊ï◊ß?", groupName: "◊û◊©◊§◊ó◊™ ◊¶◊ì◊ï◊ß",
                selectParticipants: "◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù", invitePrefix: "◊î◊ñ◊û◊ü ◊ê◊™", viewLink: "üîó ◊¶◊§◊ô◊ô◊î ◊ë◊ß◊ô◊©◊ï◊®",
                waRatingMsg: "◊ê◊î◊ë/◊î ◊ê◊™ ◊î◊®◊¢◊ô◊ï◊ü", waConfirmed: "◊ê◊ï◊©◊®!", waNegativeRating: "◊†◊°◊ï ◊û◊©◊î◊ï ◊ê◊ó◊®!"
            }
        };

        const family = [
            { id: 1, name: "Amir", phone: "972547880404", img: "amir.png" },
            { id: 2, name: "Rani", phone: "972542428664", img: "rani.png" },
            { id: 3, name: "Lia", phone: "972526765297", img: "lia.png" },
            { id: 4, name: "Gal", phone: "972553054450", img: "gal.png" }
        ];

        let currentLang = localStorage.getItem('letsdoit_lang') || 'eng';
        let currentUser = JSON.parse(localStorage.getItem('letsdoit_user_identity'));
        let activities = JSON.parse(localStorage.getItem('letsdoit_final_list')) || [];
        let myHistory = JSON.parse(localStorage.getItem('letsdoit_suggestions_history')) || [];
        let selected = []; let currentRating = 0; let editingId = null; let pressTimer;

        function toggleLanguage() { currentLang = currentLang === 'eng' ? 'heb' : 'eng'; localStorage.setItem('letsdoit_lang', currentLang); location.reload(); }
        
        function updateUILanguage() {
            const d = i18n[currentLang]; const isHeb = currentLang === 'heb';
            document.body.dir = isHeb ? 'rtl' : 'ltr';
            document.getElementById('lang-toggle').innerText = d.langBtn;
            document.getElementById('lang-toggle').style.left = isHeb ? '0px' : 'auto';
            document.getElementById('lang-toggle').style.right = isHeb ? 'auto' : '0px';
            document.getElementById('help-btn').style.left = isHeb ? 'auto' : '0px';
            document.getElementById('help-btn').style.right = isHeb ? '0px' : 'auto';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = d[el.getAttribute('data-i18n')]);
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = d[el.getAttribute('data-i18n-placeholder')]);
            if (currentUser) document.getElementById('user-info').innerHTML = `<img src="${currentUser.img}" onerror="this.src='https://via.placeholder.com/40'"> <b>${d.hiUser}, ${currentUser.name}</b>`;
        }

        function init() {
            updateUILanguage(); const params = new URLSearchParams(window.location.search);
            if (params.get('editLogistics')) {
                if (!currentUser) { document.getElementById('setup-card').classList.remove('hidden'); renderSetup(); }
                else { document.getElementById('main-app').classList.remove('hidden'); showMainApp(); openEdit(parseInt(params.get('editLogistics'))); }
                return;
            }
            if (params.get('rate')) { document.getElementById('rating-screen').classList.remove('hidden'); document.getElementById('rating-header').innerText = `${params.get('creator')} wants to: ${params.get('rate')}`; return; }
            if (!currentUser) { document.getElementById('setup-card').classList.remove('hidden'); renderSetup(); }
            else showMainApp();
        }

        function renderSetup() { document.getElementById('avatar-selector').innerHTML = family.map(f => `<div class="avatar-choice" id="choice-${f.id}" onclick="selectSelf(${f.id})"><img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/80'"><span>${f.name}</span></div>`).join(''); }
        function selectSelf(id) { document.querySelectorAll('.avatar-choice').forEach(el => el.classList.remove('active')); document.getElementById(`choice-${id}`).classList.add('active'); document.getElementById('start-btn').disabled = false; window.tempId = id; }
        function finishSetup() { currentUser = family.find(f => f.id === window.tempId); localStorage.setItem('letsdoit_user_identity', JSON.stringify(currentUser)); location.reload(); }

        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('faces-render').innerHTML = family.map(f => `<div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})"><img src="${f.img}" class="face-img" onerror="this.src='https://via.placeholder.com/55'"><p style="font-size:10px; font-weight:bold;">${f.name}</p></div>`).join('');
            renderFinalList();
        }

        function toggleFace(id) { const idx = selected.indexOf(id); idx > -1 ? selected.splice(idx, 1) : selected.push(id); updateUIState(); }
        function selectAll() { selected = (selected.length === family.length) ? [] : family.map(f => f.id); updateUIState(); }
        function clearInput() { document.getElementById('main-input').value = ""; updateUIState(); }
        function toggleSuggestLogistics() { document.getElementById('suggest-logistics-fields').classList.toggle('hidden'); }
        
        function updateUIState() {
            const val = document.getElementById('main-input').value;
            family.forEach(f => document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)));
            const btn = document.getElementById('action-btn'); btn.disabled = !(selected.length > 0 && val);
            if (selected.length > 0) {
                const target = selected.length === family.length ? i18n[currentLang].everyoneInvite : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
                btn.innerText = `${i18n[currentLang].invitePrefix} ${target}`;
            } else btn.innerText = i18n[currentLang].selectParticipants;
        }

        async function sendWA() {
            const title = document.getElementById('main-input').value;
            const desc = document.getElementById('suggest-desc').value;
            const date = document.getElementById('suggest-date').value;
            const time = document.getElementById('suggest-time').value;
            const dur = document.getElementById('suggest-duration').value;
            const urlInp = document.getElementById('suggest-url').value;
            const imagesInp = document.getElementById('suggest-images').files;
            const pNames = selected.length === family.length ? "Everyone" : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');

            let base64Images = [];
            for (let file of imagesInp) { base64Images.push(await new Promise(r => { let reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); })); }

            const suggObj = { id: Date.now(), title, desc, date, time, dur, url: urlInp, images: base64Images, creator: currentUser.name, participants: pNames, modified: new Date().toISOString() };
            myHistory.push(suggObj);
            localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory));

            let url = `${window.location.origin}${window.location.pathname}?rate=${encodeURIComponent(title)}&creator=${encodeURIComponent(currentUser.name)}&participants=${encodeURIComponent(pNames)}`;
            if(desc) url += `&details=${encodeURIComponent(desc)}`; if(date) url += `&date=${encodeURIComponent(date)}`; if(time) url += `&time=${encodeURIComponent(time)}`; if(dur) url += `&duration=${encodeURIComponent(dur)}`; if(urlInp) url += `&exturl=${encodeURIComponent(urlInp)}`;

            const phone = (selected.length === 1 && selected.length !== family.length) ? family.find(f => f.id === selected[0]).phone : "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent('üöÄ ' + currentUser.name + ' suggested: ' + title + '\n\nRate here: ' + url)}`, '_blank');
            location.reload();
        }

        function openSuggestions() {
            const sorted = myHistory.sort((a, b) => a.title.localeCompare(b.title) || new Date(b.modified) - new Date(a.modified));
            document.getElementById('suggestions-list-content').innerHTML = sorted.map(s => `
                <div class="list-item" onmousedown="startInnerPress(${s.id})" onmouseup="endInnerPress()" ontouchstart="startInnerPress(${s.id})" ontouchend="endInnerPress()">
                    <div class="item-delete" onclick="event.stopPropagation(); deleteSuggestion(${s.id})">üóëÔ∏è</div>
                    <div><b>${s.title}</b><br><small>${s.participants}</small></div>
                </div>
            `).join('') || `<p>No suggestions yet</p>`;
            document.getElementById('suggestions-panel').classList.remove('hidden');
        }

        function startInnerPress(id) { 
            pressTimer = setTimeout(() => { 
                editingId = id; 
                const s = myHistory.find(i => i.id === id);
                populateModal(s);
                document.getElementById('edit-modal').classList.remove('hidden');
            }, 600); 
        }
        function endInnerPress() { clearTimeout(pressTimer); }
        function closeSuggestions() { document.getElementById('suggestions-panel').classList.add('hidden'); }

        function populateModal(item) {
            document.getElementById('modal-edit-title').value = item.title || "";
            document.getElementById('modal-edit-desc').value = item.details || item.desc || "";
            document.getElementById('modal-edit-date').value = item.dateRaw || item.date || "";
            document.getElementById('modal-edit-time').value = item.time || "";
            document.getElementById('modal-edit-duration').value = item.duration || item.dur || "";
            document.getElementById('modal-edit-url').value = item.url || "";
        }

        async function syncAndSaveGlobal() {
            const newTitle = document.getElementById('modal-edit-title').value;
            const newDesc = document.getElementById('modal-edit-desc').value;
            const newDate = document.getElementById('modal-edit-date').value;
            const newTime = document.getElementById('modal-edit-time').value;
            const newDur = document.getElementById('modal-edit-duration').value;
            const newUrl = document.getElementById('modal-edit-url').value;
            
            const imgFiles = document.getElementById('modal-edit-images').files;
            let newImages = null;
            if (imgFiles.length > 0) {
                newImages = [];
                for (let file of imgFiles) { newImages.push(await new Promise(r => { let reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); })); }
            }

            const histIdx = myHistory.findIndex(h => h.id === editingId || (h.title === newTitle && h.creator === currentUser.name));
            if (histIdx > -1) {
                const h = myHistory[histIdx];
                h.title = newTitle; h.desc = newDesc; h.date = newDate; h.time = newTime; h.dur = newDur; h.url = newUrl;
                if(newImages) h.images = newImages;
                h.modified = new Date().toISOString();
            }

            const publicIdx = activities.findIndex(a => a.id === editingId || (a.title === newTitle && a.creator === currentUser.name));
            if (publicIdx > -1) {
                const a = activities[publicIdx];
                a.title = newTitle; a.details = newDesc; a.dateRaw = newDate; a.time = newTime; a.duration = newDur; a.url = newUrl;
                if(newImages) a.images = newImages;
            }

            localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory));
            localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
            location.reload();
        }

        function deleteSuggestion(id) { if(confirm(i18n[currentLang].deleteConfirm)) { myHistory = myHistory.filter(s => s.id !== id); localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory)); openSuggestions(); } }

        function setStars(n) { currentRating = n; document.querySelectorAll('#star-row span').forEach((s, i) => s.style.color = i < n ? '#facc15' : '#ddd'); document.getElementById('submit-vote-btn').disabled = false; }
        
        function submitRating() {
            const p = new URLSearchParams(window.location.search);
            const title = p.get('rate'); const creator = p.get('creator');
            if (currentRating >= 4) {
                const hist = myHistory.find(s => s.title === title && s.creator === creator) || {};
                activities.push({ 
                    id: Date.now(), title, creator, joinedBy: p.get('participants'), 
                    details: p.get('details') || hist.desc || '', dateRaw: p.get('date') || hist.date || '', 
                    time: p.get('time') || hist.time || '', duration: p.get('duration') || hist.dur || '', 
                    url: p.get('exturl') || hist.url || '', images: hist.images || [] 
                });
                localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
                window.open(`https://wa.me/${(family.find(f => f.name === creator) || {}).phone}?text=${encodeURIComponent('üéâ Liked your idea: "' + title + '"!')}`, '_blank');
            }
            window.location.href = window.location.origin + window.location.pathname;
        }

        function renderFinalList() {
            const todayStr = new Date().toISOString().split('T')[0];
            const sorted = [...activities].sort((a, b) => (a.dateRaw || '9999').localeCompare(b.dateRaw || '9999'));
            document.getElementById('final-list').innerHTML = sorted.map(a => {
                const creatorObj = family.find(f => f.name === a.creator);
                return `
                <div class="list-item" onclick="openEdit(${a.id})">
                    ${(currentUser && (a.creator === currentUser.name || currentUser.name === "Amir")) ? `<div class="item-delete" onclick="event.stopPropagation(); deleteIdea(${a.id})">üóëÔ∏è</div>` : ''}
                    <img src="${creatorObj ? creatorObj.img : ''}" class="creator-badge" onerror="this.src='https://via.placeholder.com/25'">
                    <b>${a.title}</b><br><small>${a.creator} | ${a.joinedBy}</small>
                    ${a.url ? `<br><a href="${a.url}" target="_blank" class="link-btn" onclick="event.stopPropagation()">${i18n[currentLang].viewLink}</a>` : ''}
                    ${a.images?.length ? `<div class="image-gallery">${a.images.map(img => `<img src="${img}">`).join('')}</div>` : ''}
                </div>
            `;
            }).join('') || `<p>No confirmed activities yet</p>`;
        }

        function openEdit(id) {
            editingId = id; let item = activities.find(a => a.id === id); const isCreator = currentUser && item.creator === currentUser.name;
            const editF = document.getElementById('unified-edit-fields');
            const viewF = document.getElementById('view-fields');
            if (isCreator) { editF.classList.remove('hidden'); viewF.classList.add('hidden'); populateModal(item); }
            else { 
                editF.classList.add('hidden'); viewF.classList.remove('hidden');
                document.getElementById('modal-close-btn').classList.remove('hidden');
                document.getElementById('view-desc').innerText = item.details || "...";
                document.getElementById('view-datetime').innerText = item.dateRaw ? `${item.dateRaw} @ ${item.time}` : "Time TBD";
                document.getElementById('view-duration').innerText = item.duration ? `Duration: ${item.duration}` : "";
                document.getElementById('view-link-container').innerHTML = item.url ? `<a href="${item.url}" target="_blank" class="link-btn">${i18n[currentLang].viewLink}</a>` : "";
                document.getElementById('view-images-container').innerHTML = (item.images || []).map(img => `<img src="${img}">`).join('');
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEdit() { document.getElementById('edit-modal').classList.add('hidden'); }
        function deleteIdea(id) { if(confirm(i18n[currentLang].deleteConfirm)) { activities = activities.filter(a => a.id !== id); localStorage.setItem('letsdoit_final_list', JSON.stringify(activities)); renderFinalList(); } }
        function resetIdentity() { localStorage.removeItem('letsdoit_user_identity'); location.reload(); }
        function openGuide() { alert('Planning: Create ideas & build excitement!\nGlobal Sync: History updates sync with public list.\nFinalizing: Confirm items in Future Activities.'); }
    </script>
</body>
</html>
