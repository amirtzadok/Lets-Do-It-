<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #76ce71;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --card-max-width: 480px;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #ffffff; 
            margin: 0; 
            height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden; 
            position: fixed;
        }

        .lang-btn {
            position: absolute;
            top: 15px;
            background: white;
            border: 1px solid #ddd;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }

        /* Setup & Creator Screens */
        #setup-card, #creator-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            padding: 20px;
            text-align: center;
            background: white;
        }

        #creator-panel {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 60px;
        }

        .logo-img { width: 160px; height: auto; margin-bottom: 15px; }
        .setup-title { font-size: 24px; font-weight: 800; margin-bottom: 20px; color: #000; }

        .avatar-options {
            display: flex;
            flex-direction: column;
            gap: 12px; 
            width: 100%;
            max-width: 280px;
            margin-bottom: 25px;
        }

        .avatar-choice {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 4px;
            border-radius: 15px;
        }

        .avatar-btn {
            width: 75px; height: 75px;
            border-radius: 50%;
            border: 4px solid transparent;
            object-fit: cover;
            margin-bottom: 4px;
        }

        .avatar-choice.active .avatar-btn { border-color: var(--whatsapp); transform: scale(1.05); }

        /* History List */
        .history-list { width: 100%; max-width: 400px; margin-top: 20px; text-align: left; }
        .history-item {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .history-controls { display: flex; gap: 10px; margin-top: 10px; }

        /* Main Screen */
        #main-content { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; height: 100vh; }
        .main-card { background: white; padding: 20px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: var(--card-max-width); margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        .face-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 100%; margin: 15px 0; }
        .face-wrapper { cursor: pointer; text-align: center; opacity: 0.4; display: flex; flex-direction: column; align-items: center; }
        .face-wrapper.selected { opacity: 1; }
        .face-img { width: 45px; height: 45px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .face-wrapper.selected .face-img { border-color: var(--primary); }
        .heart-box { width: 45px; height: 45px; background: #fff1f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; border: 3px solid transparent; }

        @media (min-width: 768px) {
            body { overflow: auto; position: static; }
            .avatar-options { flex-direction: row; max-width: 900px; gap: 60px; }
            .avatar-btn { width: 130px; height: 130px; }
        }

        .primary-btn { width: 100%; max-width: 260px; padding: 14px; background: var(--whatsapp); color: white; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; }
        .secondary-btn { background: #e2e8f0; color: #475569; padding: 8px 15px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body onload="init()">

    <button id="lang-toggle" class="lang-btn" onclick="toggleLanguage()">HEB</button>

    <div id="setup-card" class="hidden">
        <img src="logo.png" class="logo-img" onerror="this.src='https://via.placeholder.com/160?text=Logo'">
        <h2 class="setup-title" data-i18n="whoAreYou">Choose your avatar</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled data-i18n="enterApp">Let's do it!</button>
    </div>

    <div id="creator-panel" class="hidden">
        <button class="secondary-btn" onclick="closeCreatorPanel()" style="position:fixed; top:15px; left:15px;">‚úï Close</button>
        <h2 data-i18n="creatorSettings">My Profile & History</h2>
        
        <div class="avatar-options" id="creator-avatar-selector"></div>
        
        <div class="history-list">
            <h3 data-i18n="mySuggestions">My Past Suggestions</h3>
            <div id="history-content"></div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div class="main-card">
            <div id="user-info" style="display:flex; align-items:center; gap:10px; margin-bottom:15px; cursor:pointer;" onclick="openCreatorPanel()"></div>
            <h2 data-i18n="doSomething">let's do something together!</h2>
            <input type="text" id="main-input" data-i18n-placeholder="planPlaceholder" oninput="updateUIState()" style="width:100%; padding:12px; border-radius:12px; border:1px solid #ddd;">
            <div class="face-grid">
                <div id="faces-render" style="display:contents;"></div>
                <div class="face-wrapper" id="f-all" onclick="selectAll()">
                    <div class="heart-box">‚ù§Ô∏è</div>
                    <p style="font-size:10px; font-weight:bold;" data-i18n="everyone">Everyone</p>
                </div>
            </div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled data-i18n="selectParticipants" style="max-width:100%"></button>
        </div>
    </div>

    <script>
        const i18n = {
            eng: { whoAreYou: "Choose your avatar", enterApp: "Let's do it!", hiUser: "Hi", doSomething: "Let's do something together!", planPlaceholder: "What's the plan?", selectParticipants: "Select Participants", invitePrefix: "Invite", langBtn: "HEB", waMsg: "suggested: ", everyone: "Everyone", creatorSettings: "Creator Settings", mySuggestions: "My History", resend: "Resend", save: "Save" },
            heb: { whoAreYou: "◊ë◊ó◊® ◊û◊ô ◊ê◊™/◊î", enterApp: "◊ë◊ï◊ê◊ï ◊†◊™◊ó◊ô◊ú!", hiUser: "◊î◊ô◊ô", doSomething: "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊û◊©◊î◊ï ◊ë◊ô◊ó◊ì!", planPlaceholder: "◊û◊î ◊î◊™◊õ◊†◊ï◊ü?", selectParticipants: "◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù", invitePrefix: "◊î◊ñ◊û◊ü ◊ê◊™", langBtn: "ENG", waMsg: "◊î◊¶◊ô◊¢/◊î: ", everyone: "◊õ◊ï◊ú◊ù", creatorSettings: "◊ê◊ñ◊ï◊® ◊ô◊ï◊¶◊®", mySuggestions: "◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î ◊©◊ú◊ô", resend: "◊©◊ú◊ó ◊©◊ï◊ë", save: "◊©◊û◊ï◊®" }
        };

        const family = [
            { id: 1, name: "Amir", img: "amir.png", phone: "972547880404" },
            { id: 2, name: "Rani", img: "rani.png", phone: "972542428664" },
            { id: 3, name: "Lia", img: "lia.png", phone: "972526765297" },
            { id: 4, name: "Gal", img: "gal.png", phone: "972553054450" }
        ];

        let currentLang = localStorage.getItem('letsdoit_lang') || 'eng';
        let currentUser = JSON.parse(localStorage.getItem('letsdoit_user_identity'));
        let history = JSON.parse(localStorage.getItem('letsdoit_history')) || [];
        let selected = [];

        function toggleLanguage() {
            currentLang = currentLang === 'eng' ? 'heb' : 'eng';
            localStorage.setItem('letsdoit_lang', currentLang);
            location.reload();
        }

        function init() {
            document.body.dir = currentLang === 'heb' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[currentLang][el.getAttribute('data-i18n')]);
            if (!currentUser) { document.getElementById('setup-card').classList.remove('hidden'); renderAvatars('avatar-selector'); }
            else { showMainApp(); }
        }

        function renderAvatars(containerId) {
            document.getElementById(containerId).innerHTML = family.map(f => `
                <div class="avatar-choice ${currentUser?.id === f.id ? 'active' : ''}" onclick="selectSelf(${f.id}, '${containerId}')">
                    <img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/120'">
                    <span>${f.name}</span>
                </div>
            `).join('');
        }

        function selectSelf(id, containerId) {
            window.tempId = id;
            document.querySelectorAll(`#${containerId} .avatar-choice`).forEach(el => el.classList.remove('active'));
            if(containerId === 'creator-avatar-selector') {
                currentUser = family.find(f => f.id === id);
                localStorage.setItem('letsdoit_user_identity', JSON.stringify(currentUser));
                location.reload();
            } else {
                document.getElementById('start-btn').disabled = false;
            }
        }

        function finishSetup() {
            currentUser = family.find(f => f.id === window.tempId);
            localStorage.setItem('letsdoit_user_identity', JSON.stringify(currentUser));
            location.reload();
        }

        function showMainApp() {
            document.getElementById('main-content').classList.remove('hidden');
            const msg = currentLang === 'heb' ? `◊î◊ô◊ô, ${currentUser.name}` : `Hi, ${currentUser.name}`;
            document.getElementById('user-info').innerHTML = `<img src="${currentUser.img}" style="width:40px;height:40px;border-radius:50%"> <b>${msg}</b>`;
            document.getElementById('faces-render').innerHTML = family.map(f => `
                <div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})">
                    <img src="${f.img}" class="face-img" onerror="this.src='https://via.placeholder.com/50'">
                    <p style="font-size:10px; font-weight:bold;">${f.name}</p>
                </div>
            `).join('');
        }

        function openCreatorPanel() {
            document.getElementById('creator-panel').classList.remove('hidden');
            renderAvatars('creator-avatar-selector');
            renderHistory();
        }

        function closeCreatorPanel() { document.getElementById('creator-panel').classList.add('hidden'); }

        function renderHistory() {
            const myHistory = history.filter(h => h.creatorId === currentUser.id);
            document.getElementById('history-content').innerHTML = myHistory.map(h => `
                <div class="history-item">
                    <input type="text" value="${h.text}" id="hist-text-${h.id}" style="width:100%; margin-bottom:5px;">
                    <input type="text" value="${h.details || ''}" placeholder="Logistics/Details" id="hist-det-${h.id}" style="width:100%;">
                    <div class="history-controls">
                        <button class="secondary-btn" onclick="saveHistory(${h.id})">${i18n[currentLang].save}</button>
                        <button class="primary-btn" onclick="resend(${h.id})" style="padding:8px; font-size:12px;">${i18n[currentLang].resend}</button>
                    </div>
                </div>
            `).join('');
        }

        function saveHistory(id) {
            const hIdx = history.findIndex(h => h.id === id);
            history[hIdx].text = document.getElementById(`hist-text-${id}`).value;
            history[hIdx].details = document.getElementById(`hist-det-${id}`).value;
            localStorage.setItem('letsdoit_history', JSON.stringify(history));
            alert("Updated!");
        }

        function resend(id) {
            const item = history.find(h => h.id === id);
            document.getElementById('main-input').value = item.text;
            closeCreatorPanel();
            updateUIState();
        }

        function toggleFace(id) { const idx = selected.indexOf(id); idx > -1 ? selected.splice(idx, 1) : selected.push(id); updateUIState(); }
        function selectAll() { selected = (selected.length === family.length) ? [] : family.map(f => f.id); updateUIState(); }

        function updateUIState() {
            const val = document.getElementById('main-input').value;
            family.forEach(f => document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)));
            document.getElementById('f-all').classList.toggle('selected', selected.length === family.length);
            const btn = document.getElementById('action-btn');
            btn.disabled = !(selected.length > 0 && val);
            if (selected.length > 0) {
                const names = selected.length === family.length ? i18n[currentLang].everyone : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
                btn.innerText = `${i18n[currentLang].invitePrefix} ${names}`;
            }
        }

        function sendWA() {
            const plan = document.getElementById('main-input').value;
            const newId = Date.now();
            history.push({ id: newId, text: plan, creatorId: currentUser.id, details: "" });
            localStorage.setItem('letsdoit_history', JSON.stringify(history));
            
            const message = `üöÄ ${currentUser.name} ${i18n[currentLang].waMsg}${plan}`;
            const target = selected.length === family.length ? "" : family.find(f => f.id === selected[0]).phone;
            window.open(`https://wa.me/${target}?text=${encodeURIComponent(message)}`, '_blank');
        }
    </script>
</body>
</html>
