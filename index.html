<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Let's Do It! üöÄ</title>
    <style>
        :root {
            --primary: #6366f1;
            --success: #28a745;
            --bg: #f8fafc;
            --card: #ffffff;
            --warning: #f59e0b;
        }

        body, html {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            overflow-x: hidden;
        }

        /* --- GLOBAL HEADER --- */
        .app-header {
            background: var(--card);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }

        .app-header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); cursor: pointer; }

        .header-user-zone { display: flex; align-items: center; gap: 10px; }
        .not-you-link { font-size: 0.7rem; color: #ef4444; cursor: pointer; text-decoration: underline; font-weight: bold; }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; box-sizing: border-box; }
        .screen { display: none; }
        .active { display: block; }

        /* --- WELCOME SCREEN (Vertically Centered) --- */
        #welcome-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .welcome-title { font-size: 2rem; color: var(--primary); margin-bottom: 30px; }

        /* --- AVATARS & SELECTION --- */
        .avatar-container {
            display: flex; gap: 12px; overflow-x: auto;
            padding: 10px 0; margin-bottom: 20px;
            justify-content: center; width: 100%;
        }

        .avatar-wrap { text-align: center; min-width: 75px; cursor: pointer; }

        .avatar-img {
            width: 70px; height: 70px; border-radius: 50%;
            border: 4px solid transparent;
            object-fit: cover; transition: 0.2s;
        }

        /* Selection Border */
        .selected .avatar-img, .selected .heart-icon-circle {
            border: 4px solid var(--success) !important;
        }

        .heart-icon-circle {
            width: 70px; height: 70px; border-radius: 50%;
            background: #ffe4e6; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.8rem; border: 4px solid transparent;
        }

        /* --- UI ELEMENTS --- */
        label { display: block; margin-top: 15px; font-weight: bold; color: #64748b; font-size: 0.85rem; text-align: left; }
        input, select {
            width: 100%; padding: 14px; margin-top: 5px;
            border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: white; text-transform: lowercase; }
        .btn-ghost { background: #e2e8f0; color: #475569; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }

        /* --- CARDS --- */
        .activity-card {
            background: white; padding: 15px; border-radius: 12px;
            margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; text-align: left;
        }

        .star-rating { display: flex; justify-content: center; gap: 10px; margin: 20px 0; font-size: 2.2rem; }
        .star { cursor: pointer; color: #cbd5e1; }
        .star.filled { color: #fbbf24; }
    </style>
</head>
<body>

    <header class="app-header" id="main-header" style="display: none;">
        <h1 onclick="showScreen('home-screen')">Let's Do It! üöÄ</h1>
        <div class="header-user-zone">
            <div class="not-you-link" onclick="logout()">not you?</div>
            <img id="header-avatar" src="" class="avatar-img" style="width:35px; height:35px; border: 2px solid var(--primary)" onclick="showScreen('personal-area')">
        </div>
    </header>

    <div class="container">
        
        <section id="welcome-screen" class="screen active">
            <div class="welcome-title">Let's Do It! üöÄ</div>
            <p>Who is using the app?</p>
            <div class="avatar-container" id="welcome-avatar-list"></div>
            <button class="btn btn-primary" id="welcome-action-btn" onclick="confirmUser()" style="display:none; max-width: 300px;">
                Welcome...
            </button>
        </section>

        <section id="home-screen" class="screen">
            <label>The Idea</label>
            <input type="text" id="idea-name" placeholder="What's your suggestion?">
            
            <label>Invite Participants</label>
            <div class="avatar-container" id="invite-list" style="justify-content: flex-start;"></div>

            <button class="btn btn-ghost" onclick="showScreen('details-screen')">Add more details</button>
            <button class="btn btn-primary" id="invite-submit-btn" onclick="sendInvites()">invite...</button>

            <h3 style="margin-top:40px">Let's Do It List ‚ù§Ô∏è</h3>
            <div id="approved-activities-list"></div>
        </section>

        <section id="details-screen" class="screen">
            <h3>Activity Details</h3>
            <label>Date of Event</label><input type="date" id="det-date">
            <label>Start Hour</label><input type="time" id="det-time">
            <label>Duration</label>
            <select id="det-duration">
                <option value="">Choose duration...</option>
                <option value="1-3 hours">1-3 hours</option>
                <option value="half a day">Half a day</option>
                <option value="full day">Full day</option>
            </select>
            <label>Time Period</label>
            <select id="det-period">
                <option value="this week">This Week</option>
                <option value="this month">This Month</option>
                <option value="in the 3 months ahead">3 Months Ahead</option>
                <option value="this year">This Year</option>
            </select>
            <label>URL Field</label><input type="url" id="det-url" placeholder="https://...">
            <button class="btn btn-success" onclick="saveDetails()">Save</button>
            <button class="btn btn-ghost" onclick="showScreen('home-screen')">Cancel</button>
        </section>

        <section id="view-activity-screen" class="screen">
            <h2 id="view-name">Activity</h2>
            <div id="view-details-content" style="background: #eff6ff; padding: 15px; border-radius: 12px;"></div>
            <div id="view-actions"></div>
            <button class="btn btn-ghost" onclick="showScreen('home-screen')">Back</button>
        </section>

        <section id="rating-screen" class="screen">
            <h2 id="rating-subtitle">Rate Idea!</h2>
            <div class="star-rating" id="star-bar">
                <span class="star" onclick="setRating(1)">‚òÖ</span>
                <span class="star" onclick="setRating(2)">‚òÖ</span>
                <span class="star" onclick="setRating(3)">‚òÖ</span>
                <span class="star" onclick="setRating(4)">‚òÖ</span>
                <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <p id="rating-feedback" style="text-align:center; font-weight:bold; height: 20px;"></p>
            <button class="btn btn-primary" onclick="submitRating()">Let's Do It!</button>
        </section>

        <section id="personal-area" class="screen">
            <h3>My Suggestions</h3>
            <div id="my-suggestions-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home-screen')">Back</button>
        </section>

    </div>

    <script>
        const family = [
            { name: "Amir", phone: "+972547880404", img: "amir.png" },
            { name: "Rani", phone: "+972542428664", img: "rani.png" },
            { name: "Lia", phone: "+972526765297", img: "lia.png" },
            { name: "Gal", phone: "+972553054450", img: "gal.png" }
        ];

        let currentUser = null;
        let selectedWelcomeUser = null;
        let selectedParticipants = [];
        let activities = JSON.parse(localStorage.getItem('tzadokActivities')) || [];
        let currentRating = 0;
        let editingId = null;

        function showScreen(id) {
            document.getElementById('main-header').style.display = (id === 'welcome-screen') ? 'none' : 'flex';
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'home-screen') renderHome();
            if(id === 'personal-area') renderPersonalArea();
            if(id === 'welcome-screen') renderWelcome();
        }

        // --- WELCOME LOGIC ---
        function renderWelcome() {
            const list = document.getElementById('welcome-avatar-list');
            list.innerHTML = family.map(m => `
                <div class="avatar-wrap ${selectedWelcomeUser?.name === m.name ? 'selected' : ''}" onclick="pickWelcomeUser('${m.name}')">
                    <img src="${m.img}" class="avatar-img">
                    <div style="font-size:0.8rem; margin-top:5px;">${m.name}</div>
                </div>
            `).join('');
        }

        function pickWelcomeUser(name) {
            selectedWelcomeUser = family.find(f => f.name === name);
            const btn = document.getElementById('welcome-action-btn');
            btn.style.display = 'block';
            btn.innerText = `Welcome ${name}`;
            renderWelcome();
        }

        function confirmUser() {
            currentUser = selectedWelcomeUser;
            document.getElementById('header-avatar').src = currentUser.img;
            showScreen('home-screen');
        }

        function logout() {
            currentUser = null;
            selectedWelcomeUser = null;
            showScreen('welcome-screen');
        }

        // --- HOME & CREATION ---
        function renderHome() {
            const list = document.getElementById('invite-list');
            list.innerHTML = family.map(m => `
                <div class="avatar-wrap ${selectedParticipants.includes(m.name) ? 'selected' : ''}" onclick="toggleSelect('${m.name}')">
                    <img src="${m.img}" class="avatar-img">
                    <div style="font-size:0.8rem; margin-top:5px;">${m.name}</div>
                </div>
            `).join('') + `
                <div class="avatar-wrap ${selectedParticipants.includes('everyone') ? 'selected' : ''}" onclick="toggleSelect('everyone')">
                    <div class="heart-icon-circle">‚ù§Ô∏è</div>
                    <div style="font-size:0.8rem; margin-top:5px;">Everyone</div>
                </div>
            `;
            updateInviteButton();
            renderApprovedList();
        }

        function toggleSelect(name) {
            if(name === 'everyone') {
                selectedParticipants = selectedParticipants.includes('everyone') ? [] : ['everyone'];
            } else {
                if(selectedParticipants.includes('everyone')) selectedParticipants = [];
                const idx = selectedParticipants.indexOf(name);
                if(idx > -1) selectedParticipants.splice(idx, 1);
                else selectedParticipants.push(name);
            }
            renderHome();
        }

        function updateInviteButton() {
            const btn = document.getElementById('invite-submit-btn');
            if (!selectedParticipants.length) { btn.innerText = "invite..."; return; }
            if (selectedParticipants.includes('everyone')) { btn.innerText = "invite+everyone"; return; }
            const names = [...selectedParticipants];
            let formatted = names.length === 1 ? names[0] : names.slice(0, -1).join(', ') + ' & ' + names.slice(-1);
            btn.innerText = `invite+${formatted.toLowerCase()}`;
        }

        function saveDetails() {
            const data = {
                date: document.getElementById('det-date').value,
                time: document.getElementById('det-time').value,
                duration: document.getElementById('det-duration').value,
                period: document.getElementById('det-period').value,
                url: document.getElementById('det-url').value
            };
            if(editingId) {
                activities.find(a => a.id === editingId).details = data;
                editingId = null;
            } else {
                window.tempDetails = data;
            }
            localStorage.setItem('tzadokActivities', JSON.stringify(activities));
            showScreen('home-screen');
        }

        function sendInvites() {
            const idea = document.getElementById('idea-name').value;
            if(!idea) return alert("Enter an idea!");
            const newAct = {
                id: Date.now(), creator: currentUser.name, name: idea,
                participants: [...selectedParticipants], details: window.tempDetails || {}, rating: 0
            };
            activities.push(newAct);
            localStorage.setItem('tzadokActivities', JSON.stringify(activities));
            
            const phone = family.find(f => f.name === selectedParticipants[0])?.phone || family[1].phone;
            const msg = `Hey ${selectedParticipants[0]}!, ${currentUser.name} has an idea for ${idea}, rate his idea! View here: ${window.location.href}?rateId=${newAct.id}`;
            window.open(`https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(msg)}`, '_blank');
            
            selectedParticipants = []; window.tempDetails = {}; document.getElementById('idea-name').value = "";
            renderHome();
        }

        function renderApprovedList() {
            const div = document.getElementById('approved-activities-list');
            const approved = activities.filter(a => a.rating >= 4);
            div.innerHTML = approved.map(a => `
                <div class="activity-card" onclick="viewActivity(${a.id})">
                    <div><strong>${a.name} ‚ù§Ô∏è</strong><div style="font-size:0.7rem; color:gray">Period: ${a.details?.period || 'TBD'}</div></div>
                    <span>üöÄ</span>
                </div>
            `).join('');
        }

        function viewActivity(id) {
            const act = activities.find(a => a.id === id);
            showScreen('view-activity-screen');
            document.getElementById('view-name').innerText = act.name;
            const hasDetails = act.details?.date || act.details?.duration;
            document.getElementById('view-details-content').innerHTML = `
                <p><strong>Creator:</strong> ${act.creator}</p>
                <p><strong>Date:</strong> ${act.details?.date || '???'}</p>
                <p><strong>Duration:</strong> ${act.details?.duration || '???'}</p>
                ${act.details?.url ? `<p><a href="${act.details.url}" target="_blank">View Link</a></p>` : ''}
            `;
            const actions = document.getElementById('view-actions');
            actions.innerHTML = "";
            if(act.creator === currentUser.name) {
                actions.innerHTML = `<button class="btn btn-primary" onclick="editIdea(${act.id})">Edit Details</button>`;
            } else if(!hasDetails) {
                actions.innerHTML = `<button class="btn btn-warning" onclick="askForDetails('${act.creator}', '${act.name}')">Ask for Details</button>`;
            }
        }

        function askForDetails(creatorName, ideaName) {
            const creator = family.find(f => f.name === creatorName);
            const msg = `${currentUser.name} asked you to add more details about your idea: "${ideaName}"`;
            window.open(`https://wa.me/${creator.phone.replace('+','')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function editIdea(id) {
            const act = activities.find(a => a.id === id);
            editingId = id;
            showScreen('details-screen');
            document.getElementById('det-date').value = act.details?.date || '';
            document.getElementById('det-duration').value = act.details?.duration || '';
            document.getElementById('det-period').value = act.details?.period || 'this week';
            document.getElementById('det-url').value = act.details?.url || '';
        }

        // --- RATING LOGIC ---
        function setRating(val) {
            currentRating = val;
            const stars = document.querySelectorAll('.star');
            const feedback = document.getElementById('rating-feedback');
            const texts = ["", "dont want to. ‚ùå", "probably no. üëé", "maybe. üòê", "i like it. üëç", "What a wonderful idea! üòç"];
            stars.forEach((s, i) => s.classList.toggle('filled', i < val));
            feedback.innerText = texts[val];
        }

        function submitRating() {
            const id = new URLSearchParams(window.location.search).get('rateId');
            const act = activities.find(a => a.id == id);
            if(act) {
                act.rating = currentRating;
                localStorage.setItem('tzadokActivities', JSON.stringify(activities));
                const creator = family.find(f => f.name === act.creator);
                let msg = currentRating >= 4 ? `The ${currentUser.name} liked your idea! Click to add more details: ${window.location.href.split('?')[0]}` 
                                             : `Your idea did not accepted by the ${currentUser.name}. Try sending another one`;
                window.open(`https://wa.me/${creator.phone.replace('+','')}?text=${encodeURIComponent(msg)}`, '_blank');
            }
            window.location.href = window.location.pathname;
        }

        function renderPersonalArea() {
            const div = document.getElementById('my-suggestions-list');
            const myItems = activities.filter(a => a.creator === currentUser.name);
            div.innerHTML = myItems.length ? myItems.map(a => `
                <div class="activity-card" onclick="editIdea(${a.id})">
                    <div><strong>${a.name}</strong><br><small>Rating: ${a.rating}/5</small></div>
                    <span>‚úèÔ∏è</span>
                </div>
            `).join('') : "<p>No suggestions yet.</p>";
        }

        // Init Check
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('rateId')) {
            // Force user pick to rate
            showScreen('welcome-screen');
            document.querySelector('#welcome-screen p').innerText = "Pick your name to rate the idea:";
        } else {
            showScreen('welcome-screen');
        }
        renderWelcome();
    </script>
</body>
</html>
