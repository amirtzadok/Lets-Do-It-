<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #25d366;
            --heart: #f43f5e;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --star-gold: #fbbf24;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); padding: 10px; display: flex; 
            flex-direction: column; align-items: center; 
            margin: 0; min-height: 100vh; box-sizing: border-box;
            padding-bottom: 80px;
        }

        .app-header { display: flex; align-items: center; justify-content: center; width: 100%; max-width: 480px; padding: 15px 0; position: relative; }
        .app-header h1 { font-size: 24px; font-weight: 900; color: var(--primary); margin: 0; }
        .header-btn { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; position: absolute; right: 0; }
        body[dir="rtl"] .header-btn { right: auto; left: 0; }

        .card { background: white; padding: 20px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: 480px; margin-bottom: 20px; box-sizing: border-box; }
        
        .avatar-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .avatar-choice { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .avatar-btn { width: 50px; height: 50px; border-radius: 50%; border: 4px solid transparent; opacity: 0.5; object-fit: cover; }
        .avatar-choice.active .avatar-btn { border-color: var(--primary); opacity: 1; transform: scale(1.1); }

        .face-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; margin: 15px 0; }
        .face-wrapper { cursor: pointer; text-align: center; opacity: 0.4; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .face-wrapper.selected { opacity: 1; }
        .face-img { width: 42px; height: 42px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .face-wrapper.selected .face-img { border-color: var(--primary); }

        .stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; direction: ltr; }
        .star { font-size: 40px; cursor: pointer; color: #d1d5db; transition: 0.2s; }
        .star.active { color: var(--star-gold); }

        input, textarea, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; }
        .logistics-label { font-size: 12px; color: #64748b; font-weight: bold; display: block; margin-bottom: 4px; text-align: start; }

        .primary-btn { width: 100%; padding: 16px; background: var(--whatsapp); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; font-size: 17px; }
        .primary-btn:disabled { background: #cbd5e1; }
        .secondary-btn { width: 100%; padding: 10px; background: #f1f5f9; color: #475569; border: none; border-radius: 15px; margin-top: 8px; font-weight: bold; cursor: pointer; }

        .list-item { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid var(--whatsapp); position: relative; cursor: pointer; }
        body[dir="rtl"] .list-item { border-left: none; border-right: 5px solid var(--whatsapp); }
        
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        .modal-card { background: white; border-radius: 30px; padding: 25px; width: 100%; max-width: 420px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .hidden { display: none !important; }
        
        .view-data-point { text-align: start; background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 8px; font-size: 14px; }
        .view-data-point b { color: var(--primary); }
    </style>
</head>
<body onload="init()">

    <header class="app-header">
        <h1>üöÄ Let's Do It!</h1>
        <button id="lang-toggle" class="header-btn" onclick="toggleLanguage()"></button>
    </header>

    <div id="setup-card" class="card hidden">
        <h2 data-i18n="whoAreYou">Who are you?</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled data-i18n="enterApp" style="margin-top:20px;">Let's do it!</button>
    </div>

    <div id="rating-modal" class="modal-bg hidden">
        <div class="modal-card">
            <h3 id="rate-title-main"></h3>
            <h1 id="rate-activity-name" style="margin: 10px 0; color: var(--primary);"></h1>
            <div class="stars">
                <span class="star" onclick="setRating(1)">‚òÖ</span>
                <span class="star" onclick="setRating(2)">‚òÖ</span>
                <span class="star" onclick="setRating(3)">‚òÖ</span>
                <span class="star" onclick="setRating(4)">‚òÖ</span>
                <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <p id="rating-text" style="font-weight:bold;"></p>
            <button class="primary-btn" id="confirm-rate-btn" onclick="submitRating()" disabled data-i18n="submit">Send Feedback</button>
        </div>
    </div>

    <div id="details-modal" class="modal-bg hidden">
        <div class="modal-card">
            <h2 id="modal-activity-title" style="margin-bottom:20px;">Activity Details</h2>
            
            <div id="edit-area" class="hidden">
                <label class="logistics-label">Name of activity</label>
                <input type="text" id="edit-name">
                
                <label class="logistics-label">Date</label>
                <input type="date" id="edit-date">
                
                <label class="logistics-label">Start hour</label>
                <input type="time" id="edit-time">
                
                <label class="logistics-label">Duration</label>
                <select id="edit-dur">
                    <option value="1-3 hours">1-3 hours</option>
                    <option value="half a day">Half a day</option>
                    <option value="full day">Full day</option>
                </select>
                
                <label class="logistics-label">Extra details</label>
                <textarea id="edit-details" rows="3"></textarea>
                
                <label class="logistics-label">URL link</label>
                <input type="text" id="edit-url" placeholder="https://...">
                
                <button class="primary-btn" onclick="saveDetails()">Save Changes</button>
            </div>

            <div id="view-area" class="hidden">
                <div class="view-data-point"><b>Date:</b> <span id="v-date">TBD</span></div>
                <div class="view-data-point"><b>Start Hour:</b> <span id="v-time">TBD</span></div>
                <div class="view-data-point"><b>Duration:</b> <span id="v-dur">TBD</span></div>
                <div class="view-data-point"><b>Extra Details:</b> <span id="v-details">No extra info</span></div>
                <div id="v-url-container"></div>
                
                <button class="primary-btn hidden" id="nudge-btn" onclick="nudgeCreator()" style="margin-top:10px;">Add more details</button>
            </div>
            
            <button class="secondary-btn" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div id="user-info" style="display:flex; align-items:center; gap:8px; font-weight:bold;"></div>
                <span style="font-size:11px; cursor:pointer; color:#94a3b8; font-weight:bold;" onclick="resetIdentity()" data-i18n="notMe">Not you?</span>
            </div>
            <input type="text" id="main-input" data-i18n-placeholder="planPlaceholder" oninput="updateUIState()">
            <div class="face-grid" id="faces-render"></div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled data-i18n="selectParticipants">Select Participants</button>
        </div>
        <div class="card">
            <h2 data-i18n="futureActivities">üöÄ Let's Do It!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        const i18n = {
            eng: {
                langBtn: "HEB", whoAreYou: "Who are you?", enterApp: "Let's do it!", welcomeUser: "Welcome {name}",
                planPlaceholder: "What's the plan?", everyone: "Everyone", everyoneInvite: "Everyone", 
                futureActivities: "üöÄ Let's Do It!", notMe: "Not you?", groupName: "Tzadok family",
                invitePrefix: "Invite", selectParticipants: "Select Participants", submit: "Send Feedback",
                rateIdea: "Rate {name}'s idea", tryAgain: "Try another idea, {name}.", 
                addMore: "Add more details on this activity!", ratings: ["", "Don't want to", "Probably no", "Maybe", "I like it", "Let's do it!"]
            },
            heb: {
                langBtn: "ENG", whoAreYou: "◊û◊ô ◊ê◊™/◊î?", enterApp: "◊ß◊ì◊ô◊û◊î!", welcomeUser: "◊ë◊®◊ï◊ö ◊î◊ë◊ê {name}",
                planPlaceholder: "◊û◊î ◊î◊™◊õ◊†◊ï◊ü?", everyone: "◊õ◊ï◊ú◊ù", everyoneInvite: "◊õ◊ï◊ú◊ù", 
                futureActivities: "üöÄ ◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊ê◊™ ◊ñ◊î!", notMe: "◊ñ◊î ◊ú◊ê ◊ê◊™/◊î?", groupName: "◊û◊©◊§◊ó◊™ ◊¶◊ì◊ï◊ß",
                invitePrefix: "◊î◊ñ◊û◊ü ◊ê◊™", selectParticipants: "◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù", submit: "◊©◊ú◊ó ◊û◊©◊ï◊ë",
                rateIdea: "◊ì◊®◊í◊ï ◊ê◊™ ◊î◊®◊¢◊ô◊ï◊ü ◊©◊ú {name}", tryAgain: "◊†◊°◊î ◊®◊¢◊ô◊ï◊ü ◊ê◊ó◊®, {name}.", 
                addMore: "◊™◊ï◊°◊ô◊£ ◊¢◊ï◊ì ◊§◊®◊ò◊ô◊ù ◊¢◊ú ◊î◊§◊¢◊ô◊ú◊ï◊™!", ratings: ["", "◊ú◊ê ◊®◊ï◊¶◊î", "◊õ◊†◊®◊ê◊î ◊©◊ú◊ê", "◊ê◊ï◊ú◊ô", "◊ê◊ï◊î◊ë ◊ê◊™ ◊ñ◊î", "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊ê◊™ ◊ñ◊î!"]
            }
        };

        const family = [
            { id: 1, name: "Amir", phone: "972547880404", img: "amir.png" },
            { id: 2, name: "Rani", phone: "972542428664", img: "rani.png" },
            { id: 3, name: "Lia", phone: "972526765297", img: "lia.png" },
            { id: 4, name: "Gal", phone: "972553054450", img: "gal.png" }
        ];

        let currentLang = localStorage.getItem('ldit_lang') || 'eng';
        let currentUser = JSON.parse(localStorage.getItem('ldit_user'));
        let activities = JSON.parse(localStorage.getItem('ldit_list')) || [];
        let tempRating = 0, incomingIdea = null, activeActivityId = null;

        function toggleLanguage() {
            currentLang = currentLang === 'eng' ? 'heb' : 'eng';
            localStorage.setItem('ldit_lang', currentLang);
            location.reload();
        }

        function init() {
            document.body.dir = currentLang === 'heb' ? 'rtl' : 'ltr';
            document.getElementById('lang-toggle').innerText = i18n[currentLang].langBtn;
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('import')) {
                incomingIdea = { id: params.get('id'), t: params.get('t'), c: params.get('c'), p: params.get('p') };
                document.getElementById('rate-title-main').innerText = i18n[currentLang].rateIdea.replace("{name}", incomingIdea.c);
                document.getElementById('rate-activity-name').innerText = incomingIdea.t;
                document.getElementById('rating-modal').classList.remove('hidden');
            }

            if (!currentUser) { renderSetup(); document.getElementById('setup-card').classList.remove('hidden'); }
            else showMainApp();
        }

        function setRating(n) {
            tempRating = n;
            document.querySelectorAll('.star').forEach((s, i) => s.classList.toggle('active', i < n));
            document.getElementById('rating-text').innerText = i18n[currentLang].ratings[n];
            document.getElementById('confirm-rate-btn').disabled = false;
        }

        function submitRating() {
            const isHigh = tempRating >= 4;
            const msg = isHigh ? i18n[currentLang].addMore : i18n[currentLang].tryAgain.replace("{name}", incomingIdea.c);
            
            if (isHigh && !activities.find(a => a.id == incomingIdea.id)) {
                activities.push({ ...incomingIdea, title: incomingIdea.t, dateRaw: '', time: '', dur: '', details: '', url: '' });
                localStorage.setItem('ldit_list', JSON.stringify(activities));
            }

            const phone = family.find(f => f.name === incomingIdea.c)?.phone || "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            closeModals();
            if (currentUser) renderFinalList();
        }

        function renderSetup() {
            document.getElementById('avatar-selector').innerHTML = family.map(f => `
                <div class="avatar-choice" onclick="selectSelf(${f.id}, '${f.name}')">
                    <img src="${f.img}" class="avatar-btn" id="self-${f.id}">
                    <span style="font-size:11px;font-weight:bold;">${f.name}</span>
                </div>`).join('');
        }

        function selectSelf(id, name) {
            document.querySelectorAll('.avatar-btn').forEach(b => b.parentElement.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const b = document.getElementById('start-btn');
            b.disabled = false; b.innerText = i18n[currentLang].welcomeUser.replace("{name}", name);
            window.tempId = id;
        }

        function finishSetup() {
            currentUser = family.find(f => f.id === window.tempId);
            localStorage.setItem('ldit_user', JSON.stringify(currentUser));
            location.reload();
        }

        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-info').innerHTML = `<img src="${currentUser.img}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;"> ${currentUser.name}`;
            document.getElementById('faces-render').innerHTML = family.map(f => `
                <div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})">
                    <img src="${f.img}" class="face-img">
                    <p style="font-size:10px; font-weight:bold;">${f.name}</p>
                </div>`).join('') + `<div class="face-wrapper" id="f-all" onclick="selectAll()"><div style="width:42px;height:42px;background:#fff1f2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;">‚ù§Ô∏è</div><p style="font-size:10px; font-weight:bold;">${i18n[currentLang].everyone}</p></div>`;
            renderFinalList();
        }

        function toggleFace(id) {
            const idx = selected.indexOf(id);
            idx > -1 ? selected.splice(idx, 1) : selected.push(id);
            updateUIState();
        }

        function selectAll() {
            selected = (selected.length === family.length) ? [] : family.map(f => f.id);
            updateUIState();
        }

        function updateUIState() {
            const val = document.getElementById('main-input').value;
            family.forEach(f => { if(document.getElementById(`f-${f.id}`)) document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)) });
            const btn = document.getElementById('action-btn');
            btn.disabled = !(selected.length > 0 && val);
            if (selected.length > 0) btn.innerText = `${i18n[currentLang].invitePrefix} ${selected.length === family.length ? i18n[currentLang].everyoneInvite : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ')}`;
        }

        function sendWA() {
            const title = document.getElementById('main-input').value;
            const pNames = selected.length === family.length ? i18n[currentLang].groupName : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
            const params = new URLSearchParams({ import: 'true', id: Date.now(), t: title, c: currentUser.name, p: pNames });
            const waText = `üöÄ *${currentUser.name}* idea: *${title}*\nRate it:\n${window.location.origin}${window.location.pathname}?${params.toString()}`;
            window.open(`https://wa.me/${(!params.get('p').includes('&') && selected.length === 1) ? family.find(f => f.id === selected[0]).phone : ""}?text=${encodeURIComponent(waText)}`, '_blank');
            location.reload();
        }

        function renderFinalList() {
            document.getElementById('final-list').innerHTML = activities.map(a => `
                <div class="list-item" onclick="openDetails(${a.id})">
                    <div style="position:absolute; right:12px; top:12px; z-index:10;" onclick="event.stopPropagation(); deleteItem(${a.id})">üóëÔ∏è</div>
                    <b>${a.title}</b><br><small>${a.creator} | ${a.joinedBy}</small>
                    ${a.dateRaw ? `<br><span style="font-size:12px; font-weight:bold;">üìÖ ${a.dateRaw} @ ${a.time}</span>` : `<br><span style="color:var(--heart);font-size:11px;">Details missing - Tap to fill</span>`}
                </div>`).join('') || `<p>No confirmed activities.</p>`;
        }

        function openDetails(id) {
            activeActivityId = id;
            const a = activities.find(x => x.id == id);
            const isCreator = currentUser && a.creator === currentUser.name;
            
            document.getElementById('modal-activity-title').innerText = isCreator ? "Edit Logistics" : a.title;
            document.getElementById('edit-area').classList.toggle('hidden', !isCreator);
            document.getElementById('view-area').classList.toggle('hidden', isCreator);
            
            if(isCreator) {
                document.getElementById('edit-name').value = a.title;
                document.getElementById('edit-date').value = a.dateRaw;
                document.getElementById('edit-time').value = a.time;
                document.getElementById('edit-dur').value = a.dur || "1-3 hours";
                document.getElementById('edit-details').value = a.details || "";
                document.getElementById('edit-url').value = a.url;
            } else {
                document.getElementById('v-date').innerText = a.dateRaw || "TBD";
                document.getElementById('v-time').innerText = a.time || "TBD";
                document.getElementById('v-dur').innerText = a.dur || "TBD";
                document.getElementById('v-details').innerText = a.details || "No extra info";
                document.getElementById('v-url-container').innerHTML = a.url ? `<a href="${a.url}" target="_blank" class="link-btn" style="display:block; text-align:center; margin-top:10px;">Open URL Link</a>` : "";
                document.getElementById('nudge-btn').classList.toggle('hidden', !!a.time && !!a.dateRaw);
            }
            document.getElementById('details-modal').classList.remove('hidden');
        }

        function saveDetails() {
            const a = activities.find(x => x.id == activeActivityId);
            a.title = document.getElementById('edit-name').value;
            a.dateRaw = document.getElementById('edit-date').value;
            a.time = document.getElementById('edit-time').value;
            a.dur = document.getElementById('edit-dur').value;
            a.details = document.getElementById('edit-details').value;
            a.url = document.getElementById('edit-url').value;
            localStorage.setItem('ldit_list', JSON.stringify(activities));
            renderFinalList();
            closeModals();
        }

        function nudgeCreator() {
            const a = activities.find(x => x.id == activeActivityId);
            const phone = family.find(f => f.name === a.creator)?.phone || "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(i18n[currentLang].addMore + " (" + a.title + ")")}`, '_blank');
        }

        function deleteItem(id) { if(confirm("Delete?")) { activities = activities.filter(a => a.id != id); localStorage.setItem('ldit_list', JSON.stringify(activities)); renderFinalList(); } }
        function closeModals() { document.querySelectorAll('.modal-bg').forEach(m => m.classList.add('hidden')); }
        function resetIdentity() { localStorage.removeItem('ldit_user'); location.reload(); }
    </script>
</body>
</html>
