<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Do It!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --whatsapp: #58d368;
            --heart: #f43f5e;
            --bg: #f8fafc;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); padding: 10px; display: flex; 
            flex-direction: column; align-items: center; justify-content: flex-start;
            margin: 0; min-height: 100vh; box-sizing: border-box; 
        }

        .app-header {
            display: flex; align-items: center; justify-content: center;
            width: 100%; max-width: 480px; padding: 15px 0; position: relative;
        }
        .app-header h1 { font-size: 24px; font-weight: 900; color: var(--primary); margin: 0; }

        .header-btn {
            background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px;
            border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; position: absolute;
            top: 50%; transform: translateY(-50%);
        }
        #help-btn { font-size: 16px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        .card { background: white; padding: 20px; border-radius: 30px; box-shadow: var(--card-shadow); width: 100%; max-width: 480px; margin-bottom: 20px; box-sizing: border-box; }
        
        .avatar-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 5px; }
        .avatar-choice { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; }
        .avatar-btn { width: 65px; height: 65px; border-radius: 50%; border: 4px solid transparent; opacity: 0.5; object-fit: cover; }
        .avatar-choice.active .avatar-btn { border-color: var(--primary); opacity: 1; transform: scale(1.05); }

        @media (min-width: 768px) {
            body { padding-top: 20px; }
            .avatar-options { grid-template-columns: repeat(4, 1fr); }
            .card, .app-header { max-width: 600px; }
        }

        .user-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-header img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 8px; }
        
        .optional-logistics { margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; }
        .toggle-logistics-btn { background: none; border: none; color: var(--primary); font-size: 12px; font-weight: bold; cursor: pointer; padding: 5px 0; text-decoration: underline; margin-bottom: 5px; width: 100%; text-align: start; }
        
        .faces-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 15px 0; flex-wrap: wrap; }
        .face-wrapper { cursor: pointer; text-align: center; opacity: 0.4; transition: 0.3s; }
        .face-wrapper.selected { opacity: 1; }
        .face { width: 50px; height: 50px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .heart-box { width: 50px; height: 50px; background: #fff1f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        .primary-btn { width: 100%; padding: 16px; background: var(--whatsapp); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; font-size: 17px; }
        .secondary-btn { width: 100%; padding: 10px; background: #cbd5e1; color: white; border: none; border-radius: 15px; margin-top: 8px; }

        .list-item { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid var(--whatsapp); position: relative; cursor: pointer; }
        .item-delete { position: absolute; top: 12px; cursor: pointer; font-size: 16px; z-index: 5; opacity: 0.6; }
        body[dir="rtl"] .item-delete { right: auto; left: 12px; }

        .image-gallery { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; }
        .image-gallery img { height: 60px; border-radius: 8px; border: 1px solid #ddd; }
        .link-btn { display: inline-block; background: #e2e8f0; color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; text-decoration: none; margin-top: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body onload="init()">

    <header class="app-header">
        <button id="help-btn" class="header-btn" onclick="openGuide()">?</button>
        <h1 id="app-name-display">üöÄ Let's Do It!</h1>
        <button id="lang-toggle" class="header-btn" onclick="toggleLanguage()"></button>
    </header>

    <div id="guide-panel" class="card hidden" style="position: fixed; top: 5%; z-index: 200; border: 2px solid var(--primary); width: 95%; max-width: 450px;">
        <h2 data-i18n="guideTitle">How it works</h2>
        <div id="guide-content"></div>
        <button class="primary-btn" onclick="closeGuide()" data-i18n="close">Got it!</button>
    </div>

    <div id="edit-modal" class="card hidden" style="position: fixed; top: 5%; z-index: 100; border: 2px solid var(--primary); width: 90%; max-width: 400px;">
        <h3 id="modal-title" data-i18n="editLogistics">Edit Logistics</h3>
        <div id="edit-fields">
            <textarea id="edit-desc" data-i18n-placeholder="descPlaceholder" placeholder="Where / What we do?" oninput="validateLogistics()"></textarea>
            <input type="date" id="edit-date" oninput="validateLogistics()">
            <input type="time" id="edit-time" oninput="validateLogistics()">
            <select id="edit-duration" oninput="validateLogistics()">
                <option value="" disabled selected data-i18n="chooseDuration">Duration</option>
                <option value="1-3" data-i18n="dur1">1-3 hours</option>
                <option value="half" data-i18n="dur2">half a day</option>
                <option value="full" data-i18n="dur3">full day</option>
            </select>
            <button class="primary-btn" id="save-notify-btn" onclick="saveAndNotify()" disabled data-i18n="saveNotify">Save & Notify</button>
        </div>
        <div id="view-fields" class="hidden">
            <p id="view-desc" style="background:#f1f5f9; padding:12px; border-radius:12px;"></p>
            <p id="view-datetime" style="font-weight:bold; color:var(--primary);"></p>
            <p id="view-duration" style="font-style:italic; font-size:13px;"></p>
            <div id="view-link-container"></div>
            <div id="view-images-container" class="image-gallery"></div>
        </div>
        <button class="secondary-btn" onclick="closeEdit()" data-i18n="close">Close</button>
    </div>

    <div id="rating-screen" class="card hidden">
        <h2 id="rating-header"></h2>
        <div class="stars" id="star-row" style="display:flex; justify-content:center; font-size:32px; color:#ddd; cursor:pointer; margin-bottom:10px;">
            <span onclick="setStars(1)">‚òÖ</span><span onclick="setStars(2)">‚òÖ</span><span onclick="setStars(3)">‚òÖ</span><span onclick="setStars(4)">‚òÖ</span><span onclick="setStars(5)">‚òÖ</span>
        </div>
        <button class="primary-btn" id="submit-vote-btn" onclick="submitRating()" disabled data-i18n="submitVote">Let's do it!</button>
    </div>

    <div id="suggestions-panel" class="card hidden" style="position: fixed; top: 5%; z-index: 101; border: 2px solid var(--whatsapp); width: 95%; max-width: 450px; max-height: 85vh; overflow-y: auto;">
        <h2 data-i18n="mySuggestionsTitle">My Suggestions</h2>
        <div id="suggestions-list-content"></div>
        <button class="secondary-btn" onclick="closeSuggestions()" data-i18n="close">Close</button>
    </div>

    <div id="setup-card" class="card hidden">
        <h2 data-i18n="whoAreYou">Who are you?</h2>
        <div class="avatar-options" id="avatar-selector"></div>
        <button class="primary-btn" id="start-btn" onclick="finishSetup()" disabled data-i18n="enterApp">Let's do it!</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="card">
            <div class="user-header">
                <div id="user-info" class="user-info" onclick="openSuggestions()"></div>
                <span style="font-size:11px; cursor:pointer; color:#94a3b8;" onclick="resetIdentity()" data-i18n="notMe">Not me?</span>
            </div>
            <h2 data-i18n="doSomething">let's do something together!</h2>
            <div class="input-row">
                <input type="text" id="main-input" data-i18n-placeholder="planPlaceholder" oninput="updateUIState()">
                <button style="background:none; border:none; color:#ccc; cursor:pointer;" onclick="clearInput()">‚úï</button>
            </div>
            <button class="toggle-logistics-btn" onclick="toggleSuggestLogistics()" data-i18n="addDetailsNow">+ Add details now (optional)</button>
            <div id="suggest-logistics-fields" class="hidden optional-logistics">
                <textarea id="suggest-desc" data-i18n-placeholder="descPlaceholder"></textarea>
                <div style="display:flex; gap:5px;"><input type="date" id="suggest-date" style="flex:1;"><input type="time" id="suggest-time" style="flex:1;"></div>
                <select id="suggest-duration">
                    <option value="" disabled selected data-i18n="chooseDuration">Duration</option>
                    <option value="1-3" data-i18n="dur1">1-3 hours</option>
                    <option value="half" data-i18n="dur2">half a day</option>
                    <option value="full" data-i18n="dur3">full day</option>
                </select>
                <input type="text" id="suggest-url" placeholder="Paste link (URL)">
                <input type="file" id="suggest-images" multiple accept="image/*">
            </div>
            <div class="faces-container">
                <div id="faces-render" style="display:flex; gap:8px;"></div>
                <div class="face-wrapper" id="f-all" onclick="selectAll()"><div class="heart-box">‚ù§Ô∏è</div><p style="font-size:10px;" data-i18n="everyone">Everyone</p></div>
            </div>
            <button class="primary-btn" id="action-btn" onclick="sendWA()" disabled data-i18n="selectParticipants"></button>
        </div>
        <div class="card">
            <h2 data-i18n="futureActivities">üöÄ Future Activities!</h2>
            <div id="final-list"></div>
        </div>
    </div>

    <script>
        const i18n = {
            eng: {
                langBtn: "HEB", guideTitle: "User Guide", close: "Close",
                g1Title: "1. Planning", g1Body: "Create ideas, pick members, and add photos/links to build excitement!",
                g2Title: "2. My Suggestions", g2Body: "Click your avatar for history. Long-press to edit and sync details with the final list.",
                g3Title: "3. Finalizing", g3Body: "High ratings automatically add items to the list. You can update logistics anytime.",
                submitVote: "Let's do it!", editLogistics: "Edit Logistics", descPlaceholder: "Where / What we do?", 
                saveNotify: "Save & Notify", whoAreYou: "Who are you?", enterApp: "Enter", notMe: "Not me?", 
                hiUser: "Hi", doSomething: "Let's do something together!", planPlaceholder: "What's the plan?", 
                everyone: "Everyone", futureActivities: "üöÄ Future Activities!", addDetailsNow: "+ Add details now",
                chooseDuration: "Duration", dur1: "1-3 hours", dur2: "half a day", dur3: "full day", 
                mySuggestionsTitle: "My Suggestions", deleteConfirm: "Delete this?", groupName: "Tzadok family",
                selectParticipants: "Select Participants", invitePrefix: "Invite", viewLink: "üîó View Link",
                waRatingMsg: "liked your idea", waConfirmed: "Confirmed! Added to list.", waNegativeRating: "Try another one!",
                waSuggested: "suggested:", innerLongPressTip: "(Long press to edit details)", update: "Update"
            },
            heb: {
                langBtn: "ENG", guideTitle: "◊û◊ì◊®◊ô◊ö ◊ú◊û◊©◊™◊û◊©", close: "◊°◊í◊ï◊®",
                g1Title: "1. ◊™◊õ◊†◊ï◊ü", g1Body: "◊¶◊®◊ï ◊®◊¢◊ô◊ï◊†◊ï◊™, ◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù ◊ï◊î◊ï◊°◊ô◊§◊ï ◊™◊û◊ï◊†◊ï◊™/◊ß◊ô◊©◊ï◊®◊ô◊ù ◊õ◊ì◊ô ◊ú◊î◊ú◊î◊ô◊ë ◊ê◊™ ◊õ◊ï◊ú◊ù!",
                g2Title: "2. ◊î◊î◊¶◊¢◊ï◊™ ◊©◊ú◊ô", g2Body: "◊ú◊ó◊¶◊ï ◊¢◊ú ◊î◊ê◊ï◊ï◊ò◊ê◊® ◊ú◊î◊ô◊°◊ò◊ï◊®◊ô◊î. ◊ú◊ó◊ô◊¶◊î ◊ê◊®◊ï◊õ◊î ◊ú◊¢◊®◊ô◊õ◊î ◊ï◊°◊†◊õ◊®◊ï◊ü ◊î◊§◊®◊ò◊ô◊ù ◊¢◊ù ◊î◊®◊©◊ô◊û◊î ◊î◊°◊ï◊§◊ô◊™.",
                g3Title: "3. ◊°◊í◊ô◊®◊™ ◊§◊®◊ò◊ô◊ù", g3Body: "◊ì◊ô◊®◊ï◊í ◊í◊ë◊ï◊î ◊û◊ï◊°◊ô◊£ ◊§◊®◊ô◊ò◊ô◊ù ◊ú◊®◊©◊ô◊û◊î ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™. ◊†◊ô◊™◊ü ◊ú◊¢◊ì◊õ◊ü ◊§◊®◊ò◊ô◊ù ◊ë◊õ◊ú ◊©◊ú◊ë.",
                submitVote: "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊ê◊™ ◊ñ◊î!", editLogistics: "◊¢◊®◊ï◊ö ◊§◊®◊ò◊ô◊ù", descPlaceholder: "◊ê◊ô◊§◊î / ◊û◊î ◊¢◊ï◊©◊ô◊ù?", 
                saveNotify: "◊©◊û◊ï◊® ◊ï◊¢◊ì◊õ◊ü", whoAreYou: "◊û◊ô ◊ê◊™/◊î?", enterApp: "◊õ◊†◊ô◊°◊î", notMe: "◊ú◊ê ◊ê◊†◊ô?", 
                hiUser: "◊î◊ô◊ô", doSomething: "◊ë◊ï◊ê◊ï ◊†◊¢◊©◊î ◊û◊©◊î◊ï ◊ë◊ô◊ó◊ì!", planPlaceholder: "◊û◊î ◊î◊™◊õ◊†◊ï◊ü?", 
                everyone: "◊õ◊ï◊ú◊ù", futureActivities: "üöÄ ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊¢◊™◊ô◊ì◊ô◊ï◊™!", addDetailsNow: "+ ◊î◊ï◊°◊ô◊§◊ï ◊§◊®◊ò◊ô◊ù ◊¢◊õ◊©◊ô◊ï",
                chooseDuration: "◊û◊©◊ö ◊ñ◊û◊ü", dur1: "1-3 ◊©◊¢◊ï◊™", dur2: "◊ó◊¶◊ô ◊ô◊ï◊ù", dur3: "◊ô◊ï◊ù ◊©◊ú◊ù", 
                mySuggestionsTitle: "◊î◊î◊¶◊¢◊ï◊™ ◊©◊ú◊ô", deleteConfirm: "◊ú◊û◊ó◊ï◊ß?", groupName: "◊û◊©◊§◊ó◊™ ◊¶◊ì◊ï◊ß",
                selectParticipants: "◊ë◊ó◊®◊ï ◊û◊©◊™◊™◊§◊ô◊ù", invitePrefix: "◊î◊ñ◊û◊ü ◊ê◊™", viewLink: "üîó ◊¶◊§◊ô◊ô◊î ◊ë◊ß◊ô◊©◊ï◊®",
                waRatingMsg: "◊ê◊î◊ë/◊î ◊ê◊™ ◊î◊®◊¢◊ô◊ï◊ü", waConfirmed: "◊ê◊ï◊©◊®! ◊†◊ï◊°◊£ ◊ú◊®◊©◊ô◊û◊î.", waNegativeRating: "◊†◊°◊ï ◊û◊©◊î◊ï ◊ê◊ó◊®!",
                waSuggested: "◊î◊¶◊ô◊¢/◊î:", innerLongPressTip: "(◊ú◊ó◊ô◊¶◊î ◊ê◊®◊ï◊õ◊î ◊ú◊¢◊®◊ô◊õ◊™ ◊§◊®◊ò◊ô◊ù)", update: "◊¢◊ì◊õ◊ü"
            }
        };

        const family = [
            { id: 1, name: "Amir", phone: "972547880404", img: "amir.png" },
            { id: 2, name: "Rani", phone: "972542428664", img: "rani.png" },
            { id: 3, name: "Lia", phone: "972526765297", img: "lia.png" },
            { id: 4, name: "Gal", phone: "972553054450", img: "gal.png" }
        ];

        let currentLang = localStorage.getItem('letsdoit_lang') || 'eng';
        let currentUser = JSON.parse(localStorage.getItem('letsdoit_user_identity'));
        let activities = JSON.parse(localStorage.getItem('letsdoit_final_list')) || [];
        let myHistory = JSON.parse(localStorage.getItem('letsdoit_suggestions_history')) || [];
        let selected = []; let currentRating = 0; let editingId = null; let pressTimer;

        function toggleLanguage() { currentLang = currentLang === 'eng' ? 'heb' : 'eng'; localStorage.setItem('letsdoit_lang', currentLang); location.reload(); }
        
        function updateUILanguage() {
            const d = i18n[currentLang]; const isHeb = currentLang === 'heb';
            document.body.dir = isHeb ? 'rtl' : 'ltr';
            document.getElementById('lang-toggle').innerText = d.langBtn;
            document.getElementById('lang-toggle').style.left = isHeb ? '0px' : 'auto';
            document.getElementById('lang-toggle').style.right = isHeb ? 'auto' : '0px';
            document.getElementById('help-btn').style.left = isHeb ? 'auto' : '0px';
            document.getElementById('help-btn').style.right = isHeb ? '0px' : 'auto';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = d[el.getAttribute('data-i18n')]);
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = d[el.getAttribute('data-i18n-placeholder')]);
            if (currentUser) document.getElementById('user-info').innerHTML = `<img src="${currentUser.img}" onerror="this.src='https://via.placeholder.com/40'"> <b>${d.hiUser}, ${currentUser.name}</b>`;
        }

        function init() {
            updateUILanguage(); const params = new URLSearchParams(window.location.search);
            if (params.get('editLogistics')) {
                if (!currentUser) { document.getElementById('setup-card').classList.remove('hidden'); renderSetup(); }
                else { document.getElementById('main-app').classList.remove('hidden'); showMainApp(); openEdit(parseInt(params.get('editLogistics'))); }
                return;
            }
            if (params.get('rate')) { document.getElementById('rating-screen').classList.remove('hidden'); document.getElementById('rating-header').innerText = `${params.get('creator')} ${i18n[currentLang].waSuggested} ${params.get('rate')}`; return; }
            if (!currentUser) { document.getElementById('setup-card').classList.remove('hidden'); renderSetup(); }
            else showMainApp();
        }

        function renderSetup() { document.getElementById('avatar-selector').innerHTML = family.map(f => `<div class="avatar-choice" id="choice-${f.id}" onclick="selectSelf(${f.id})"><img src="${f.img}" class="avatar-btn" onerror="this.src='https://via.placeholder.com/80'"><span>${f.name}</span></div>`).join(''); }
        function selectSelf(id) { document.querySelectorAll('.avatar-choice').forEach(el => el.classList.remove('active')); document.getElementById(`choice-${id}`).classList.add('active'); document.getElementById('start-btn').disabled = false; window.tempId = id; }
        function finishSetup() { currentUser = family.find(f => f.id === window.tempId); localStorage.setItem('letsdoit_user_identity', JSON.stringify(currentUser)); location.reload(); }

        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('faces-render').innerHTML = family.map(f => `<div class="face-wrapper" id="f-${f.id}" onclick="toggleFace(${f.id})"><img src="${f.img}" class="face" onerror="this.src='https://via.placeholder.com/55'"><p style="font-size:10px;">${f.name}</p></div>`).join('');
            renderFinalList();
        }

        function toggleFace(id) { const idx = selected.indexOf(id); idx > -1 ? selected.splice(idx, 1) : selected.push(id); updateUIState(); }
        function selectAll() { selected = (selected.length === family.length) ? [] : family.map(f => f.id); updateUIState(); }
        function clearInput() { document.getElementById('main-input').value = ""; updateUIState(); }
        function toggleSuggestLogistics() { document.getElementById('suggest-logistics-fields').classList.toggle('hidden'); }
        function updateUIState() {
            const val = document.getElementById('main-input').value;
            family.forEach(f => document.getElementById(`f-${f.id}`).classList.toggle('selected', selected.includes(f.id)));
            const btn = document.getElementById('action-btn'); btn.disabled = !(selected.length > 0 && val);
            if (selected.length > 0) {
                const target = selected.length === family.length ? i18n[currentLang].everyoneInvite : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');
                btn.innerText = `${i18n[currentLang].invitePrefix} ${target}`;
            } else btn.innerText = i18n[currentLang].selectParticipants;
        }

        async function sendWA() {
            const title = document.getElementById('main-input').value;
            const desc = document.getElementById('suggest-desc').value;
            const date = document.getElementById('suggest-date').value;
            const time = document.getElementById('suggest-time').value;
            const dur = document.getElementById('suggest-duration').value;
            const urlInp = document.getElementById('suggest-url').value;
            const imagesInp = document.getElementById('suggest-images').files;
            const pNames = selected.length === family.length ? "Everyone" : family.filter(f => selected.includes(f.id)).map(f => f.name).join(' & ');

            let base64Images = [];
            for (let file of imagesInp) { base64Images.push(await new Promise(r => { let reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); })); }

            const suggObj = { id: Date.now(), title, desc, date, time, dur, url: urlInp, images: base64Images, creator: currentUser.name, participants: pNames, modified: new Date().toISOString() };
            myHistory = myHistory.filter(s => s.title !== title); myHistory.push(suggObj);
            localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory));

            let url = `${window.location.origin}${window.location.pathname}?rate=${encodeURIComponent(title)}&creator=${encodeURIComponent(currentUser.name)}&participants=${encodeURIComponent(pNames)}`;
            if(desc) url += `&details=${encodeURIComponent(desc)}`; if(date) url += `&date=${encodeURIComponent(date)}`; if(time) url += `&time=${encodeURIComponent(time)}`; if(dur) url += `&duration=${encodeURIComponent(dur)}`; if(urlInp) url += `&exturl=${encodeURIComponent(urlInp)}`;

            const phone = (selected.length === 1 && selected.length !== family.length) ? family.find(f => f.id === selected[0]).phone : "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent('üöÄ ' + currentUser.name + ' ' + i18n[currentLang].waSuggested + ' ' + title + '\n\n' + i18n[currentLang].waRateHere + '\n' + url)}`, '_blank');
            location.reload();
        }

        function openSuggestions() {
            const sorted = myHistory.sort((a, b) => a.title.localeCompare(b.title) || new Date(b.modified) - new Date(a.modified));
            document.getElementById('suggestions-list-content').innerHTML = sorted.map(s => `
                <div class="list-item" onmousedown="startInnerPress(${s.id})" onmouseup="endInnerPress()" ontouchstart="startInnerPress(${s.id})" ontouchend="endInnerPress()">
                    <div class="item-delete" onclick="event.stopPropagation(); deleteSuggestion(${s.id})">üóëÔ∏è</div>
                    <div id="inner-view-${s.id}"><b>${s.title}</b><br><small>${s.participants}</small></div>
                    <div id="inner-edit-${s.id}" class="hidden">
                        <input type="text" value="${s.desc || ''}" id="hist-desc-${s.id}" placeholder="${i18n[currentLang].descPlaceholder}">
                        <input type="date" value="${s.date || ''}" id="hist-date-${s.id}">
                        <input type="time" value="${s.time || ''}" id="hist-time-${s.id}">
                        <input type="text" value="${s.url || ''}" id="hist-url-${s.id}" placeholder="Link (URL)">
                        <input type="file" id="hist-images-${s.id}" multiple accept="image/*">
                        <button class="primary-btn" style="background:var(--whatsapp);" onclick="updateAndSaveSuggestion(${s.id})">${i18n[currentLang].update}</button>
                    </div>
                </div>
            `).join('') || `<p>${i18n[currentLang].noSuggestions}</p>`;
            document.getElementById('suggestions-panel').classList.remove('hidden');
        }

        async function updateAndSaveSuggestion(id) {
            const s = myHistory.find(i => i.id === id);
            s.desc = document.getElementById(`hist-desc-${id}`).value;
            s.date = document.getElementById(`hist-date-${id}`).value;
            s.time = document.getElementById(`hist-time-${id}`).value;
            s.url = document.getElementById(`hist-url-${id}`).value;
            s.modified = new Date().toISOString();

            const imgFiles = document.getElementById(`hist-images-${id}`).files;
            if (imgFiles.length > 0) {
                s.images = [];
                for (let file of imgFiles) { s.images.push(await new Promise(r => { let reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); })); }
            }

            // SYNCHRONIZATION: Update public list if this activity exists there
            const publicIdx = activities.findIndex(a => a.title === s.title && a.creator === s.creator);
            if (publicIdx > -1) {
                activities[publicIdx].details = s.desc;
                activities[publicIdx].dateRaw = s.date;
                activities[publicIdx].time = s.time;
                activities[publicIdx].url = s.url;
                activities[publicIdx].images = s.images;
                localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
            }

            localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory));
            location.reload();
        }

        function deleteSuggestion(id) { if(confirm(i18n[currentLang].deleteConfirm)) { myHistory = myHistory.filter(s => s.id !== id); localStorage.setItem('letsdoit_suggestions_history', JSON.stringify(myHistory)); openSuggestions(); } }
        function openGuide() { openEditModalWithGuide(); } // Dummy for brevity, guide logic is similar to Suggestions
        function closeGuide() { document.getElementById('guide-panel').classList.add('hidden'); }
        function startInnerPress(id) { pressTimer = setTimeout(() => { document.getElementById(`inner-view-${id}`).classList.add('hidden'); document.getElementById(`inner-edit-${id}`).classList.remove('hidden'); }, 600); }
        function endInnerPress() { clearTimeout(pressTimer); }
        function closeSuggestions() { document.getElementById('suggestions-panel').classList.add('hidden'); }

        function setStars(n) { currentRating = n; document.querySelectorAll('#star-row span').forEach((s, i) => s.style.color = i < n ? '#facc15' : '#ddd'); document.getElementById('submit-vote-btn').disabled = false; }
        
        function submitRating() {
            const p = new URLSearchParams(window.location.search);
            const title = p.get('rate'); const creator = p.get('creator');
            if (currentRating >= 4) {
                const hist = myHistory.find(s => s.title === title && s.creator === creator) || {};
                activities.push({ 
                    id: Date.now(), title, creator, joinedBy: p.get('participants'), 
                    details: p.get('details') || hist.desc || '', 
                    dateRaw: p.get('date') || hist.date || '', 
                    time: p.get('time') || hist.time || '', 
                    duration: p.get('duration') || hist.dur || '', 
                    url: p.get('exturl') || hist.url || '', 
                    images: hist.images || [] 
                });
                localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
                window.open(`https://wa.me/${(family.find(f => f.name === creator) || {}).phone}?text=${encodeURIComponent('üéâ ' + currentUser.name + ' ' + i18n[currentLang].waRatingMsg + ' "' + title + '"!')}`, '_blank');
            }
            window.location.href = window.location.origin + window.location.pathname;
        }

        function renderFinalList() {
            const todayStr = new Date().toISOString().split('T')[0];
            const sorted = [...activities].sort((a, b) => (a.dateRaw || '9999').localeCompare(b.dateRaw || '9999'));
            document.getElementById('final-list').innerHTML = sorted.map(a => `
                <div class="list-item" onclick="openEdit(${a.id})">
                    ${(currentUser && (a.creator === currentUser.name || currentUser.name === "Amir")) ? `<div class="item-delete" onclick="event.stopPropagation(); deleteIdea(${a.id})">üóëÔ∏è</div>` : ''}
                    <b>${a.title}${ (a.details && a.dateRaw) ? ' ‚ù§Ô∏è' : '' }</b><br><small>${a.creator} | ${a.joinedBy}</small>
                    ${a.url ? `<br><a href="${a.url}" target="_blank" class="link-btn" onclick="event.stopPropagation()">${i18n[currentLang].viewLink}</a>` : ''}
                    ${a.images?.length ? `<div class="image-gallery">${a.images.map(img => `<img src="${img}">`).join('')}</div>` : ''}
                    ${a.dateRaw ? `<br><small>üìÖ ${a.dateRaw} @ ${a.time}</small>` : ''}
                </div>
            `).join('') || `<p>${i18n[currentLang].noActivities}</p>`;
        }

        function openEdit(id) {
            editingId = id; let item = activities.find(a => a.id === id); const isCreator = currentUser && item.creator === currentUser.name;
            document.getElementById('modal-title').innerText = isCreator ? i18n[currentLang].editLogistics : i18n[currentLang].viewLogistics;
            document.getElementById('edit-fields').classList.toggle('hidden', !isCreator);
            document.getElementById('view-fields').classList.toggle('hidden', isCreator);
            if (isCreator) { document.getElementById('edit-desc').value = item.details; document.getElementById('edit-date').value = item.dateRaw; document.getElementById('edit-time').value = item.time; }
            else { 
                document.getElementById('view-desc').innerText = item.details || "..."; 
                document.getElementById('view-datetime').innerText = item.dateRaw ? `${item.dateRaw} @ ${item.time}` : "...";
                document.getElementById('view-link-container').innerHTML = item.url ? `<a href="${item.url}" target="_blank" class="link-btn">${i18n[currentLang].viewLink}</a>` : "";
                document.getElementById('view-images-container').innerHTML = (item.images || []).map(img => `<img src="${img}">`).join('');
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function validateLogistics() { document.getElementById('save-notify-btn').disabled = !document.getElementById('edit-desc').value; }
        function saveAndNotify() {
            const item = activities.find(a => a.id === editingId);
            item.details = document.getElementById('edit-desc').value; item.dateRaw = document.getElementById('edit-date').value; item.time = document.getElementById('edit-time').value;
            localStorage.setItem('letsdoit_final_list', JSON.stringify(activities));
            window.open(`https://wa.me/?text=${encodeURIComponent('‚úÖ *Update:* ' + item.title + '\nüìç ' + item.details)}`, '_blank');
            location.reload();
        }

        function closeEdit() { document.getElementById('edit-modal').classList.add('hidden'); }
        function deleteIdea(id) { if(confirm(i18n[currentLang].deleteConfirm)) { activities = activities.filter(a => a.id !== id); localStorage.setItem('letsdoit_final_list', JSON.stringify(activities)); renderFinalList(); } }
        function resetIdentity() { localStorage.removeItem('letsdoit_user_identity'); location.reload(); }
        function openGuide() {
            const d = i18n[currentLang];
            document.getElementById('guide-content').innerHTML = `<div class="guide-step"><b>${d.g1Title}</b><p>${d.g1Body}</p></div><div class="guide-step"><b>${d.g2Title}</b><p>${d.g2Body}</p></div><div class="guide-step"><b>${d.g3Title}</b><p>${d.g3Body}</p></div>`;
            document.getElementById('guide-panel').classList.remove('hidden');
        }
    </script>
</body>
</html>
