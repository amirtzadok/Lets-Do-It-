<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üöÄ Let's Do It!</title>
    <style>
        :root {
            --primary: #6366f1;
            --success: #28a745;
            --bg: #f8fafc;
            --card: #ffffff;
            --warning: #f59e0b;
            --disabled: #cbd5e1;
        }

        body, html {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            overflow: hidden;
        }

        /* --- GLOBAL HEADER --- */
        .app-header {
            background: var(--card);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }

        .app-header h1 { 
            margin: 0; font-size: 1.2rem; color: var(--primary); 
            cursor: pointer; font-weight: bold; 
        }

        .header-user-zone { display: flex; align-items: center; gap: 10px; }
        .not-you-link { font-size: 0.75rem; color: #ef4444; cursor: pointer; text-decoration: underline; font-weight: bold; }

        .container { 
            padding: 20px; max-width: 500px; margin: 0 auto; 
            box-sizing: border-box; height: calc(100% - 60px); overflow-y: auto; 
        }

        .screen { display: none; height: 100%; }
        .active { display: block; }

        /* --- WELCOME SCREEN (Grouped Vertical Centering) --- */
        #welcome-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            background-color: var(--bg);
        }

        .welcome-title { font-size: 1.8rem; color: var(--primary); margin-bottom: 5px; font-weight: bold; }

        .avatar-column {
            display: flex;
            flex-direction: column; 
            gap: 12px;
            margin: 25px 0;
            width: 100%;
            align-items: center; 
        }

        .avatar-wrap { 
            display: flex; align-items: center; gap: 15px; 
            width: 200px; cursor: pointer; padding: 8px;
            border-radius: 50px; transition: background 0.2s;
            justify-content: flex-start;
        }

        .avatar-img {
            width: 50px; height: 50px; border-radius: 50%;
            border: 4px solid transparent; object-fit: cover;
        }

        .selected .avatar-img { border: 4px solid var(--success) !important; }
        .selected.avatar-wrap { background: #dcfce7; }

        /* --- UI ELEMENTS --- */
        label { display: block; margin-top: 15px; font-weight: bold; color: #64748b; font-size: 0.85rem; text-align: left; }
        input, select {
            width: 100%; padding: 12px; margin-top: 5px;
            border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: bold; font-size: 1rem; cursor: pointer; transition: background 0.3s;
        }
        
        #welcome-action-btn { background: var(--disabled); color: #64748b; margin-top: 10px; width: 80%; max-width: 250px; }
        #welcome-action-btn.ready { background: var(--primary); color: white; }

        .btn-primary { background: var(--primary); color: white; text-transform: lowercase; }
        .btn-ghost { background: #e2e8f0; color: #475569; margin-top: 15px; }
        .btn-success { background: var(--success); color: white; margin-top: 15px; }

        /* --- CREATION SCREEN --- */
        #invite-list {
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            padding: 10px 0;
            justify-content: center; 
        }

        .avatar-wrap-h { text-align: center; min-width: 70px; }

        /* --- LISTS --- */
        .activity-card {
            background: white; padding: 15px; border-radius: 12px;
            margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }

        .star-rating { display: flex; justify-content: center; gap: 8px; margin: 15px 0; font-size: 2.2rem; }
        .star { cursor: pointer; color: #cbd5e1; }
        .star.filled { color: #fbbf24; }
    </style>
</head>
<body>

    <header class="app-header" id="main-header" style="display: none;">
        <h1 onclick="showScreen('home-screen')">üöÄ Let's Do It!</h1>
        <div class="header-user-zone">
            <div class="not-you-link" onclick="logout()">not you?</div>
            <img id="header-avatar" src="" class="avatar-img" style="width:35px; height:35px; border: 2px solid var(--primary)" onclick="showScreen('personal-area')">
        </div>
    </header>

    <section id="welcome-screen" class="screen active">
        <div class="welcome-title">üöÄ Let's Do It!</div>
        <p style="margin: 0; font-size: 0.9rem; color: #64748b;">Who is using the app?</p>
        
        <div class="avatar-column" id="welcome-avatar-list"></div>

        <button class="btn" id="welcome-action-btn" onclick="confirmUser()">
            Welcome...
        </button>
    </section>

    <div class="container" id="app-container" style="display:none;">
        
        <section id="home-screen" class="screen">
            <label>The Idea</label>
            <input type="text" id="idea-name" placeholder="What's your suggestion?">
            
            <label>Invite Participants</label>
            <div id="invite-list"></div>

            <button class="btn btn-ghost" onclick="showScreen('details-screen')">Add more details</button>
            <button class="btn btn-primary" id="invite-submit-btn" onclick="sendInvites()" style="margin-top:15px;">invite...</button>

            <h3 style="margin-top:30px; font-weight: bold;">Let's Do It List ‚ù§Ô∏è</h3>
            <div id="approved-activities-list"></div>
        </section>

        <section id="details-screen" class="screen">
            <h3 style="font-weight: bold;">Activity Details</h3>
            <label>Date of Event</label><input type="date" id="det-date">
            <label>Start Hour</label><input type="time" id="det-time">
            <label>Duration</label>
            <select id="det-duration">
                <option value="">Choose duration...</option>
                <option value="1-3 hours">1-3 hours</option>
                <option value="half a day">Half a day</option>
                <option value="full day">Full day</option>
            </select>
            <label>Time Period</label>
            <select id="det-period">
                <option value="this week">This Week</option>
                <option value="this month">This Month</option>
                <option value="in 3 months">3 Months Ahead</option>
                <option value="this year">This Year</option>
            </select>
            <label>URL Field</label><input type="url" id="det-url" placeholder="https://...">
            <button class="btn btn-success" onclick="saveDetails()">Save</button>
            <button class="btn btn-ghost" onclick="showScreen('home-screen')">Cancel</button>
        </section>

        <section id="rating-screen" class="screen">
            <h2 id="rating-subtitle" style="font-weight: bold;">üöÄ Rate Idea!</h2>
            <div class="star-rating" id="star-bar">
                <span class="star" onclick="setRating(1)">‚òÖ</span>
                <span class="star" onclick="setRating(2)">‚òÖ</span>
                <span class="star" onclick="setRating(3)">‚òÖ</span>
                <span class="star" onclick="setRating(4)">‚òÖ</span>
                <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <p id="rating-feedback" style="text-align:center; font-weight:bold; height: 20px;"></p>
            <button class="btn btn-primary" onclick="submitRating()">Let's Do It!</button>
        </section>

        <section id="personal-area" class="screen">
            <h3 style="font-weight: bold;">My Suggestions</h3>
            <div id="my-suggestions-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home-screen')">Back</button>
        </section>
    </div>

    <script>
        const family = [
            { name: "Amir", phone: "+972547880404", img: "amir.png" },
            { name: "Rani", phone: "+972542428664", img: "rani.png" },
            { name: "Lia", phone: "+972526765297", img: "lia.png" },
            { name: "Gal", phone: "+972553054450", img: "gal.png" }
        ];

        let currentUser = null;
        let selectedWelcomeUser = null;
        let selectedParticipants = [];
        let activities = JSON.parse(localStorage.getItem('tzadokActivities')) || [];
        let currentRating = 0;

        function showScreen(id) {
            const isWelcome = id === 'welcome-screen';
            document.getElementById('main-header').style.display = isWelcome ? 'none' : 'flex';
            document.getElementById('app-container').style.display = isWelcome ? 'none' : 'block';
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id === 'home-screen') renderHome();
            if(id === 'welcome-screen') renderWelcome();
            if(id === 'personal-area') renderPersonalArea();
        }

        function renderWelcome() {
            const list = document.getElementById('welcome-avatar-list');
            list.innerHTML = family.map(m => `
                <div class="avatar-wrap ${selectedWelcomeUser?.name === m.name ? 'selected' : ''}" onclick="pickWelcomeUser('${m.name}')">
                    <img src="${m.img}" class="avatar-img">
                    <span style="font-weight:bold;">${m.name}</span>
                </div>
            `).join('');
        }

        function pickWelcomeUser(name) {
            selectedWelcomeUser = family.find(f => f.name === name);
            const btn = document.getElementById('welcome-action-btn');
            btn.classList.add('ready');
            btn.innerText = `Welcome ${name}`;
            renderWelcome();
        }

        // --- FIX IMPLEMENTED HERE ---
        function confirmUser() {
            if(!selectedWelcomeUser) return;
            currentUser = selectedWelcomeUser;
            document.getElementById('header-avatar').src = currentUser.img;
            
            // Check if user came from an Invite Link (Rate Mode)
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.has('rateId')) {
                showScreen('rating-screen');
            } else {
                showScreen('home-screen');
            }
        }

        function logout() {
            currentUser = null;
            selectedWelcomeUser = null;
            const btn = document.getElementById('welcome-action-btn');
            btn.classList.remove('ready');
            btn.innerText = "Welcome...";
            showScreen('welcome-screen');
        }

        function renderHome() {
            const list = document.getElementById('invite-list');
            list.innerHTML = family.map(m => `
                <div class="avatar-wrap-h" onclick="toggleSelect('${m.name}')">
                    <img src="${m.img}" class="avatar-img" style="width:55px; height:55px; border: 4px solid ${selectedParticipants.includes(m.name) ? 'var(--success)' : 'transparent'}">
                    <div style="font-size:0.7rem;">${m.name}</div>
                </div>
            `).join('') + `
                <div class="avatar-wrap-h" onclick="toggleSelect('everyone')" style="cursor:pointer;">
                    <div class="heart-icon-circle" style="width:55px; height:55px; border-radius:50%; background:#ffe4e6; display:flex; align-items:center; justify-content:center; border: 4px solid ${selectedParticipants.includes('everyone') ? 'var(--success)' : 'transparent'}">‚ù§Ô∏è</div>
                    <div style="font-size:0.7rem;">Everyone</div>
                </div>
            `;
            updateInviteButton();
            renderApprovedList();
        }

        function toggleSelect(name) {
            if(name === 'everyone') {
                selectedParticipants = selectedParticipants.includes('everyone') ? [] : ['everyone'];
            } else {
                if(selectedParticipants.includes('everyone')) selectedParticipants = [];
                const idx = selectedParticipants.indexOf(name);
                if(idx > -1) selectedParticipants.splice(idx, 1);
                else selectedParticipants.push(name);
            }
            renderHome();
        }

        function updateInviteButton() {
            const btn = document.getElementById('invite-submit-btn');
            if (!selectedParticipants.length) { btn.innerText = "invite..."; return; }
            if (selectedParticipants.includes('everyone')) { btn.innerText = "invite+everyone"; return; }
            const names = [...selectedParticipants];
            let formatted = names.length === 1 ? names[0] : names.slice(0, -1).join(', ') + ' & ' + names.slice(-1);
            btn.innerText = `invite+${formatted.toLowerCase()}`;
        }

        function saveDetails() {
            window.tempDetails = {
                date: document.getElementById('det-date').value,
                duration: document.getElementById('det-duration').value,
                period: document.getElementById('det-period').value,
                url: document.getElementById('det-url').value
            };
            showScreen('home-screen');
        }

        function sendInvites() {
            const idea = document.getElementById('idea-name').value;
            if(!idea) return alert("Enter an idea!");
            const newAct = {
                id: Date.now(), creator: currentUser.name, name: idea,
                participants: [...selectedParticipants], details: window.tempDetails || {}, rating: 0
            };
            activities.push(newAct);
            localStorage.setItem('tzadokActivities', JSON.stringify(activities));
            
            const target = selectedParticipants[0];
            const phone = family.find(f => f.name === target)?.phone || family[1].phone;
            
            // --- FIX: Cleaner URL generation ---
            // Ensures we don't end up with index.html?rateId=123?rateId=456
            const cleanUrl = window.location.origin + window.location.pathname;
            const msg = `Hey ${target}!, ${currentUser.name} has an idea for ${idea}, rate his idea! View here: ${cleanUrl}?rateId=${newAct.id}`;
            
            window.open(`https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(msg)}`, '_blank');
            
            selectedParticipants = []; document.getElementById('idea-name').value = "";
            renderHome();
        }

        function renderApprovedList() {
            const div = document.getElementById('approved-activities-list');
            const approved = activities.filter(a => a.rating >= 4);
            div.innerHTML = approved.map(a => `<div class="activity-card"><strong>${a.name} ‚ù§Ô∏è</strong><span>üöÄ</span></div>`).join('');
        }

        function setRating(val) {
            currentRating = val;
            const stars = document.querySelectorAll('.star');
            const feedback = document.getElementById('rating-feedback');
            const texts = ["", "dont want to. ‚ùå", "probably no. üëé", "maybe. üòê", "i like it. üëç", "What a wonderful idea! üòç"];
            stars.forEach((s, i) => s.classList.toggle('filled', i < val));
            feedback.innerText = texts[val];
        }

        function submitRating() {
            const id = new URLSearchParams(window.location.search).get('rateId');
            const act = activities.find(a => a.id == id);
            if(act) {
                act.rating = currentRating;
                localStorage.setItem('tzadokActivities', JSON.stringify(activities));
                const creator = family.find(f => f.name === act.creator);
                let backMsg = currentRating >= 4 ? `the ${currentUser.name} liked your idea` : `Your idea did not accepted by the ${currentUser.name}. Try sending another one`;
                window.open(`https://wa.me/${creator.phone.replace('+','')}?text=${encodeURIComponent(backMsg)}`, '_blank');
            }
            // Clear params and reload
            window.location.href = window.location.pathname;
        }

        function renderPersonalArea() {
            const div = document.getElementById('my-suggestions-list');
            const myItems = activities.filter(a => a.creator === currentUser.name);
            div.innerHTML = myItems.map(a => `<div class="activity-card">${a.name} (Rating: ${a.rating}/5)</div>`).join('');
        }

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('rateId')) {
            showScreen('welcome-screen');
            document.querySelector('#welcome-screen p').innerText = "Please identify yourself to rate:";
        } else {
            showScreen('welcome-screen');
        }
        renderWelcome();
    </script>
</body>
</html>
